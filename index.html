<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title id="title-window">Encuesta de Satisfacci√≥n</title>
<link rel="icon" type="image/jpeg" href="a.jpg">

<style>
  
  body {
    font-family: Arial, sans-serif;
    background-color: #d4f0d4;
    margin: 0;
    padding: 0;
  }

  /* Overlay */
 #overlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background-color: rgba(212,240,212,0.9);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:9998;
    font-size:24px;
    color:#4CAF50;
  }
  .overlay-content {
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
  }
  .icono svg { width:48px; height:48px; }
  .barra {
    width:100px; height:6px;
    background:#c0f0c2;
    border-radius:3px;
    margin:10px 0;
    overflow:hidden;
  }
  .progreso {
    width:50%;
    height:100%;
    background:#2e7d32;
    animation:carga 1s infinite alternate;
  }
  @keyframes carga { from{width:10%} to{width:90%} }

  /* Pantalla de idioma */
  #pantalla-idioma {
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background-color: #d4f0d4;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }
  #pantalla-idioma h2 { font-size:28px; margin-bottom:30px; text-align:center; }
  #pantalla-idioma button {
    padding:15px 25px;
    margin:10px;
    font-size:18px;
    border:none;
    border-radius:5px;
    cursor:pointer;
    background-color:#4CAF50;
    color:white;
    transition:0.2s;
  }
  #pantalla-idioma button:hover { background-color:#45a049; }

  header {
    background-color:#4CAF50;
    height:100px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    padding:0 15px;
    position:relative;
  }
  header .header-content { display:flex; align-items:center; gap:10px; }
  header img { height:80px; width:auto; }
  header h1 { color:white; font-size:30px; margin:0; text-align:center; }
  #volver-idioma { cursor:pointer; fill:white; width:40px; height:40px; }

  main {
    max-width:600px;
    margin:20px auto;
    padding:1em;
    background:white;
    border-radius:10px;
    box-shadow:0 0 10px rgba(0,0,0,0.1);
    display:none;
  }

  label { display:block; margin-top:10px; font-weight:bold; }
  input, textarea, select {
    width:100%;
    padding:8px;
    margin-top:5px;
    border-radius:5px;
    border:1px solid #ccc;
    box-sizing:border-box;
    resize:none;
    overflow:hidden;
  }
  .autoexpand { overflow:hidden; }

  .btn-group {
    display:flex;
    justify-content:space-between;
    margin-top:5px;
  }
  .btn-group button {
    flex:1;
    margin-right:5px;
    padding:10px;
    border-radius:5px;
    border:1px solid #4CAF50;
    background:white;
    color:#4CAF50;
    font-weight:bold;
    cursor:pointer;
    transition:0.2s;
  }
  .btn-group button:last-child { margin-right:0; }
  .btn-group button.selected { background:#4CAF50; color:white; }

  button#guardarEncuesta {
    background-color:#4CAF50;
    color:white;
    border:none;
    padding:10px 20px;
    margin-top:15px;
    cursor:pointer;
    border-radius:5px;
    font-size:16px;
    width:100%;
  }
  button#guardarEncuesta:hover { background-color:#45a049; }

  #mas-info a { color:#007bff; text-decoration:none; font-weight:bold; }

.error-msg {
  color: red;
  font-size: 14px;
  margin-top: 5px;
  display: none; /* Oculto por defecto */
}

.field-error {
  border: 2px solid red !important;
}

.confirm-overlay {
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
}

.confirm-box {
  background:white;
  padding:25px;
  border-radius:10px;
  text-align:center;
  width:80%;
  max-width:350px;
}

.btn-verde {
  background:#4CAF50;
  color:white;
  padding:10px 20px;
  border:none;
  margin:10px;
  cursor:pointer;
  border-radius:5px;
}

.btn-rojo {
  background:#e53935;
  color:white;
  padding:10px 20px;
  border:none;
  margin:10px;
  cursor:pointer;
  border-radius:5px;
}

.group-error {
  border: 2px solid #ff4d4d !important;
  border-radius: 8px;
  padding: 5px;
  animation: glowError 0.6s ease-in-out infinite alternate;
}

@keyframes glowError {
  from { box-shadow: 0 0 5px rgba(255, 77, 77, 0.5); }
  to   { box-shadow: 0 0 14px rgba(255, 0, 0, 0.9); }
}

.input-error {
  border: 2px solid #ff4d4d !important;
  border-radius: 6px;
  animation: glowInput 0.6s ease-in-out infinite alternate;
}

@keyframes glowInput {
  from { box-shadow: 0 0 5px rgba(255, 77, 77, 0.4); }
  to   { box-shadow: 0 0 12px rgba(255, 0, 0, 0.9); }
}

#mensaje-estado {
  width: 100%;
  text-align: center;
  padding: 12px;
  font-size: 18px;
  font-weight: bold;
  border-radius: 6px;
  display: none;
  margin-bottom: 15px;
}

.msg-ok {
  background: #4CAF50;
  color: white;
  display: block !important;
}

.msg-error {
  background: #e53935;
  color: white;
  display: block !important;
}

</style>
</head>

<body>

<!-- Overlay -->
<div id="overlay">
  <div class="overlay-content">
    <div class="icono">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48">
        <path fill="#2e7d32" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5 14.5 7.62 14.5 9 13.38 11.5 12 11.5z"/>
      </svg>
    </div>
    <div class="barra">
      <div class="progreso"></div>
    </div>
    <p id="overlay-msg">Cargando...</p>
  </div>
</div>

<!-- Pantalla de idioma -->
<div id="pantalla-idioma">
  <h2 id="pantalla-idioma-titulo">Seleccione su idioma / Select your language / S√©lectionnez votre langue</h2>
  <button data-lang="es">Espa√±ol</button>
  <button data-lang="en">English</button>
  <button data-lang="fr">Fran√ßais</button>
</div>

<header>
  <div class="header-content">
    <svg id="volver-idioma" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M15 6l-6 6 6 6" stroke-width="2" stroke="white" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <img src="a.jpg" alt="Logo">
    <h1 id="titulo-encuesta">Encuesta de Satisfacci√≥n</h1>
  </div>
</header>

<main id="main-encuesta">

  <div id="mensaje-estado"></div>

  <form id="encuestaForm" autocomplete="off">
    <label id="label-nombre" for="nombre">Nombre:</label>
    <textarea id="nombre" name="nombre" class="autoexpand" rows="1" autocomplete="off"></textarea>
    <div class="error-msg" id="error-nombre"></div>

    <label id="label-lugar" for="lugar">Lugar:</label>
    <textarea id="lugar" name="lugar" class="autoexpand" rows="1" autocomplete="off"></textarea>
    <div class="error-msg" id="error-lugar"></div>

    <label id="label-fecha" for="fecha">Fecha:</label>
    <input type="text" id="fecha" name="fecha">
    <div class="error-msg" id="error-fecha"></div>

    <label id="label-tour" for="tour">Tour:</label>
    <textarea id="tour" name="tour" class="autoexpand" rows="1" autocomplete="off" ></textarea>
    <div class="error-msg" id="error-tour"></div>

    <label id="label-operador">Operador:</label>
    <div class="btn-group" data-field="operador">
      <button type="button">Excelente</button>
      <button type="button">Bueno</button>
      <button type="button">Regular</button>
      <button type="button">Malo</button>
    </div>

    <label id="label-conductor">Conductor:</label>
    <div class="btn-group" data-field="conductor">
      <button type="button">Excelente</button>
      <button type="button">Bueno</button>
      <button type="button">Regular</button>
      <button type="button">Malo</button>
    </div>

    <label id="label-transporte">Transporte:</label>
    <div class="btn-group" data-field="transporte">
      <button type="button">Excelente</button>
      <button type="button">Bueno</button>
      <button type="button">Regular</button>
      <button type="button">Malo</button>
    </div>

    <label id="label-alimentos">Alimentos:</label>
    <div class="btn-group" data-field="alimentos">
      <button type="button">Excelente</button>
      <button type="button">Bueno</button>
      <button type="button">Regular</button>
      <button type="button">Malo</button>
    </div>

    <label id="label-comentarios" for="comentarios">Comentarios (opcional):</label>
    <textarea id="comentarios" name="comentarios" class="autoexpand" rows="4" autocomplete="off"></textarea>

    <button type="button" id="guardarEncuesta">Terminar Encuesta</button>
  </form>

  <hr style="margin:30px 0;">
  <section id="mas-info" style="text-align:center; padding:20px; background-color:#e8f5e9; border-radius:10px;">
    <h2 id="titulo-mas-info">Obtenga m√°s informaci√≥n</h2>
    <div style="display:flex; justify-content:space-around; flex-wrap:wrap; margin-top:20px; gap:20px;">
      <div>
        <img src="QR1.png" alt="QR Kichan Bajlum Oficial" width="200" height="200">
        <p id="txtOficial"><a href="https://www.kichantravel.com/" target="_blank">Kichan Bajlum Oficial</a></p>
      </div>
      <div>
        <img src="QR2.png" alt="QR Kichan Bajlum Facebook" width="200" height="200">
        <p id="txtFacebook"><a href="https://www.facebook.com/KichanBajlumOficial/" target="_blank">Kichan Bajlum Facebook</a></p>
      </div>
      <div>
        <img src="QR3.png" alt="QR Kichan Bajlum Tripadvisor" width="200" height="200">
        <p id="txtTripadvisor"><a href="https://www.tripadvisor.com.mx/Attraction_Review-g249851-d10294242-Reviews-Kichan_Bajlum_Tour_Operator-Palenque_Southern_Mexico.html" target="_blank">Kichan Bajlum Tripadvisor</a></p>
      </div>
    </div>
  </section>
</main>

<link rel="stylesheet" href="https://unpkg.com/flatpickr/dist/flatpickr.min.css">

<script src="https://unpkg.com/flatpickr/dist/flatpickr.min.js"></script>

<!-- Idiomas -->
<script src="https://unpkg.com/flatpickr/dist/l10n/es.js"></script>
<script src="https://unpkg.com/flatpickr/dist/l10n/fr.js"></script>

<!-- Librer√≠a html2pdf (OBLIGATORIA) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>

  function mensajeOK() {
  const box = document.getElementById("mensaje-estado");
  box.className = "msg-ok";
  box.textContent = "Encuesta enviada correctamente";
  box.style.display = "block";
  setTimeout(() => box.style.display = "none", 3000);
}

function mensajeERROR() {
  const box = document.getElementById("mensaje-estado");
  box.className = "msg-error";
  box.textContent = "Error al enviar encuesta";
  box.style.display = "block";
  setTimeout(() => box.style.display = "none", 3000);
}

  document.addEventListener("DOMContentLoaded", () => {

    document.title = "Encuesta de Satisfacci√≥n";
document.getElementById("title-window").textContent = "Encuesta de Satisfacci√≥n";

    window.fpFecha = null;

function add(id, event, handler) {
  const el = document.getElementById(id);
  if (!el) {
    console.warn("Elemento no encontrado:", id);
    return;
  }
  el.addEventListener(event, handler);
}

  let idioma = "es"; // evita el ReferenceError

/*=============================================================
   TRADUCCIONES
============================================================ */
const traducciones = {
  es: {
    alertaTitulo: "¬øDesea continuar?",
    continuar: "Continuar",
    cancelar: "Cancelar",
    msgCampo: "Por favor complete este campo.",
    titulo: "Encuesta de Satisfaci√≥n",
    header: "Encuesta de Satisfacci√≥n"
  },
  en: {
    alertaTitulo: "Do you want to continue?",
    continuar: "Continue",
    cancelar: "Cancel",
    msgCampo: "Please fill out this field.",
    titulo: "Encuesta de Satisfaci√≥n",
    header: "Satisfaction Survey"
  },
  fr: {
    alertaTitulo: "Voulez-vous continuer ?",
    continuar: "Continuer",
    cancelar: "Annuler",
    msgCampo: "Veuillez remplir ce champ.",
    titulo: "Encuesta de Satisfaci√≥n",
    header: "Enqu√™te de Satisfaction"
  }
};

let idiomaActual = "es";

document.title = "Encuesta de Satisfacci√≥n"; // siempre en espa√±ol en la selecci√≥n

/* ============================================================
   BOT√ìN VOLVER A IDIOMA ‚Äî AHORA FUNCIONA
============================================================ */
document.getElementById("volver-idioma").addEventListener("click", () => {
  document.getElementById("pantalla-idioma").style.display = "flex";
  document.getElementById("main-encuesta").style.display = "none";
});

/* ============================================================
   AUTOEXPAND
============================================================ */
document.querySelectorAll(".autoexpand").forEach(area => {
  area.addEventListener("input", () => {
    area.style.height = "auto";
    area.style.height = area.scrollHeight + "px";
  });
});

/* ============================================================
   BOTONES DE GRUPO
============================================================ */
document.querySelectorAll(".btn-group").forEach(group => {
  group.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      group.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
    });
  });
});

document.querySelectorAll("#pantalla-idioma button").forEach(boton => {
  boton.addEventListener("click", () => {

    idiomaActual = boton.dataset.lang;

    // Pantallas
    document.getElementById("pantalla-idioma").style.display = "none";
    document.getElementById("main-encuesta").style.display = "block";
    document.getElementById("overlay").style.display = "none";

    document.title = "Encuesta de Satisfacci√≥n";

    /* ============================================================
   LIMPIAR FORMULARIO AL CAMBIAR DE IDIOMA
============================================================ */
function limpiarCamposEncuesta() {

  const inputs = document.querySelectorAll(
    "input[type='text'], input[type='number'], textarea"
  );
  inputs.forEach(i => i.value = "");

  const radios = document.querySelectorAll("input[type='radio']");
  radios.forEach(r => r.checked = false);

  const selects = document.querySelectorAll("select");
  selects.forEach(s => s.selectedIndex = 0);

  // La fecha NO se borra porque la auto-generas con flatpickr
}

    // Textos
    cambiarIdioma(idiomaActual);
    
     // üî• LIMPIAR TODO AL CAMBIAR DE IDIOMA
    limpiarCamposEncuesta();

setTimeout(() => {
    if (window.fpFecha) window.fpFecha.destroy();

    window.fpFecha = flatpickr("#fecha", {
        dateFormat: "d/m/Y",
        locale: flatpickr.l10ns[idiomaActual]
    });
}, 200);

  });
});

function limpiarFormulario() {
  // Campos de texto y textarea
  ["nombre", "lugar", "fecha", "tour", "comentarios"].forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      campo.value = "";
      campo.style.height = "auto"; // reset del autoexpand
    }
  });

  // Botones seleccionados
  document.querySelectorAll(".btn-group button.selected").forEach(btn => {
    btn.classList.remove("selected");
  });

  // Borrar mensajes de error
  document.querySelectorAll(".error-msg").forEach(err => {
    err.style.display = "none";
  });

  // Quitar efectos de error
  document.querySelectorAll(".input-error").forEach(el => {
    el.classList.remove("input-error");
  });

  document.querySelectorAll(".group-error").forEach(el => {
    el.classList.remove("group-error");
  });
}

/* ============================================================
   VALIDACI√ìN
============================================================ */
function validarCampos() {
  const t = traducciones[idiomaActual];
  let ok = true;

  // CAMPOS DE TEXTO
  const camposTexto = ["nombre", "lugar", "fecha", "tour"];

  camposTexto.forEach(id => {
    let campo = document.getElementById(id);
    let error = document.getElementById("error-" + id);

    if (!campo.value.trim()) {
      ok = false;

      campo.classList.add("input-error");
      error.textContent = t.msgCampo;
      error.style.display = "block";

    } else {
      campo.classList.remove("input-error");
      error.style.display = "none";
    }
  });

  // CAMPOS DE OPCIONES (BOTONES)
  const grupos = ["operador", "conductor", "transporte", "alimentos"];

  grupos.forEach(id => {
    const group = document.querySelector(`.btn-group[data-field="${id}"]`);
    const seleccionado = group.querySelector(".selected");

    const msg = (idiomaActual === "es")
      ? "Seleccione una opci√≥n"
      : (idiomaActual === "en")
        ? "Please select an option"
        : "Veuillez s√©lectionner une option";

    if (!seleccionado) {
      ok = false;

      group.classList.add("group-error");

      let err = document.getElementById("error-" + id);
      if (!err) {
        err = document.createElement("div");
        err.id = "error-" + id;
        err.className = "error-msg";
        group.insertAdjacentElement("afterend", err);
      }

      err.textContent = msg;
      err.style.display = "block";

    } else {
      group.classList.remove("group-error");

      const err = document.getElementById("error-" + id);
      if (err) err.style.display = "none";
    }
  });

  return ok;
}

/* ============================================================
   ALERTA PERSONALIZADA ‚Äî FUNCIONAL Y TRADUCIBLE
============================================================ */
function mostrarAlerta(callback) {
  const t = traducciones[idiomaActual];

  document.querySelectorAll(".confirm-overlay").forEach(e => e.remove());

  const overlay = document.createElement("div");
  overlay.className = "confirm-overlay";

  const box = document.createElement("div");
  box.className = "confirm-box";
  box.innerHTML = `
    <h3>${t.alertaTitulo}</h3>
    <button id="btnConfirmar" class="btn-verde">${t.continuar}</button>
    <button id="btnCancelar" class="btn-rojo">${t.cancelar}</button>
  `;

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  document.getElementById("btnConfirmar").onclick = () => {
    overlay.remove();
    callback(true);
  };
  document.getElementById("btnCancelar").onclick = () => {
    overlay.remove();
    callback(false);
  };
}

/* ============================================================
   ERRORES PERSONALIZADOS (MEJORADOS)
============================================================ */
const erroresEnvio = {
  sinInternet:            "00",
  timeout:                "01",
  dns:                    "02",
  firewall:               "03",
  ssl:                    "04",
  noServidor:             "05",
  conexionCerrada:        "06",
  conexionRechazada:      "07",
  redLenta:               "08",
  canalFallido:           "09",

  pdfNoGenerado:          "10",
  pdfCorrupto:            "11",
  pdfVacio:               "12",
  base64Invalido:         "13",
  pdfMuyGrande:           "14",
  permisoPdf:             "15",
  sinMemoria:             "16",
  capturaFallo:           "17",
  conversionFallo:        "18",
  pdfIncompleto:          "19",

  server500:              "20",
  serverVacio:            "21",
  tokenInvalido:          "22",
  permisoServidor:        "23",
  rutaNoPermitida:        "24",
  driveCaido:             "25",
  archivoNoPermitido:     "26",
  driveLleno:             "27",
  errorInterno:           "28",
  respuestaInvalida:      "29",

  desconocido:            "99",

  // ‚ö° NUEVOS ERRORES PARA DETECTAR BLOQUEOS REALES ‚ö°
  mixedContent:           "31", // HTTP tratando de hablar con HTTPS
  corsBloqueado:          "32", // Apps Script no permite la petici√≥n
  sslRechazado:           "33", // Certificado no v√°lido (pasa en redes p√∫blicas)
  fetchMuerto:            "34", // Error gen√©rico pero NO desconocido
  firewallHotel:          "35",

};

// --- DETECTOR REAL DE ERRORES CORS ---
function detectarErrorCORS(error) {
  const errText = error?.message || "";

  // Mensajes que indican claramente problemas CORS
  if (
    errText.includes("CORS") ||
    errText.includes("Access-Control-Allow-Origin") ||
    errText.includes("bloqueada") ||
    errText.includes("same-origin") ||
    errText.includes("mismo origen") ||
    errText.includes("Failed to fetch") ||
    errText.includes("TypeError: Failed to fetch")
  ) {
    return "cors";
  }

  return "otro";
}

/* ============================================================
   ENV√çO REAL
============================================================ */
async function enviarADrive(pdfBase64) {

  if (!navigator.onLine) {
    throw { codigo: erroresEnvio.sinInternet };
  }

  if (!pdfBase64) {
    throw { codigo: erroresEnvio.pdfNoGenerado };
  }

  if (pdfBase64.length < 50) {
    throw { codigo: erroresEnvio.pdfVacio };
  }

  try {
    const resp = await fetch(
      "https://script.google.com/macros/s/AKfycbzTFXLQI5KzzUBNWJnNi8HCz5m7szjdQTY7ReHVe-E0r7EnfAY5PJlC3nt6PtrhGJ_D_Q/exec",
      {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          archivo: pdfBase64,
          nombre: "Encuesta_" + Date.now() + ".pdf"
        })
      }
    );

    const texto = await resp.text();

    if (!texto.includes("ok")) {
      throw { codigo: erroresEnvio.errorInterno };
    }

    return texto;

  } catch (err) {

    if (detectarErrorCORS(err)) {
      throw { codigo: erroresEnvio.corsBloqueado };
    }

    if (err.codigo) throw err;

    throw { codigo: erroresEnvio.desconocido };
  }
}

/* ============================================================
   FUNCI√ìN PARA OBTENER EL C√ìDIGO DEL ERROR
============================================================ */
function obtenerCodigoError(err) {
  console.log("Error completo recibido:", err); // üî• debug

  if (!err) return erroresEnvio.desconocido;

  // Si ya trae c√≥digo v√°lido
  if (err.codigo && Object.values(erroresEnvio).includes(err.codigo)) {
    return err.codigo;
  }

  // Detectar fallos de PDF
  if (err.message && err.message.includes("PDF")) {
    return erroresEnvio.pdfCorrupto;
  }

  // Si es un objeto Response de fetch
  if (err instanceof Response) {
    if (!err.ok) {
      if (err.status === 500) return erroresEnvio.server500;
      return erroresEnvio.respuestaInvalida;
    }
  }

  // Intentar detectar errores de fetch / red
  if (err.message) {
    const msg = err.message.toLowerCase();
    if (msg.includes("failed to fetch") || msg.includes("networkerror") || msg.includes("network request failed")) {
      if (location.protocol !== "https:") return erroresEnvio.mixedContent;
      return erroresEnvio.noServidor;
    }
    if (msg.includes("cors")) return erroresEnvio.corsBloqueado;
    if (msg.includes("ssl")) return erroresEnvio.sslRechazado;
  }

  // Por defecto, desconocido
  return erroresEnvio.desconocido;
}

/* ============================================================
   BOT√ìN PRINCIPAL ‚Äî AHORA S√ç FUNCIONA
============================================================ */
document.getElementById("guardarEncuesta").addEventListener("click", () => {
  if (!validarCampos()) return;

  mostrarAlerta(async ok => {
    if (!ok) return;

const mensajesEnvio = {
  es: "Enviando...",
  en: "Sending...",
  fr: "Envoi..."
};

mostrarOverlay(mensajesEnvio[idiomaActual] || "Enviando...");

    try {
      const pdf = await generarPDF();
      const base64 = pdf.split(",")[1];

      await enviarADrive(base64);

      const terminadoMsg = idiomaActual === "es" ? 
                            "Encuesta terminada correctamente, puede cerrar esta ventana. ¬°Gracias!" :
                            idiomaActual === "en" ? 
                            "Survey completed successfully, you may close this window. Thank you!" :
                            "Enqu√™te termin√©e avec succ√®s, vous pouvez fermer cette fen√™tre. Merci !";

      setOverlayMensaje(terminadoMsg);
      setTimeout(() => ocultarOverlay(), 1800);

    } catch (err) {
      const codigo = obtenerCodigoError(err);

      const errorMsg = idiomaActual === "es" ? 
                        `Error: ${codigo}` :
                        idiomaActual === "en" ? 
                        `Error: ${codigo}` :
                        `Erreur : ${codigo}`;

      setOverlayMensaje(errorMsg);
      document.getElementById("overlay-msg").style.color = "green";
      document.getElementById("overlay-msg").style.fontWeight = "bold";

      setTimeout(() => ocultarOverlay(), 2500);
    }
  });

async function generarPDF() {
  const el = document.getElementById("main-encuesta");

  return await html2pdf()
    .from(el)
    .set({
      margin: 5,
      filename: "Encuesta_" + Date.now() + ".pdf",
      image: { type: "jpeg", quality: 1.0 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
    })
    .outputPdf("datauristring");
}
});

// Quitar error autom√°ticamente al escribir
["nombre", "lugar", "fecha", "tour"].forEach(id => {
  const campo = document.getElementById(id);

  campo.addEventListener("input", () => {
    campo.classList.remove("input-error");
    const err = document.getElementById("error-" + id);
    if (err) err.style.display = "none";
  });
});

// Quitar error autom√°ticamente al seleccionar botones
["operador", "conductor", "transporte", "alimentos"].forEach(id => {
  const group = document.querySelector(`.btn-group[data-field="${id}"]`);

  group.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      group.classList.remove("group-error");

      const err = document.getElementById("error-" + id);
      if (err) err.style.display = "none";
    });
  });
});

function mostrarOverlay(msg = "Cargando...") {
  const ov = document.getElementById("overlay");
  ov.style.display = "flex";
  setOverlayMensaje(msg);
}

function ocultarOverlay() {
  document.getElementById("overlay").style.display = "none";
}

function setOverlayMensaje(msg) {
  document.getElementById("overlay-msg").textContent = msg;
}

document.getElementById("volver-idioma").addEventListener("click", () => {

  document.getElementById("pantalla-idioma").style.display = "flex";
  document.getElementById("main-encuesta").style.display = "none";

  // üî• Limpia TODOS los errores y estilos
  document.querySelectorAll(".error-msg").forEach(e => e.style.display = "none");
  document.querySelectorAll(".input-error").forEach(e => e.classList.remove("input-error"));
  document.querySelectorAll(".group-error").forEach(e => e.classList.remove("group-error"));
  document.querySelectorAll(".selected").forEach(e => e.classList.remove("selected"));

});

// === GUARDAR SELECCIONES DE RADIO ===
function guardarSeleccionRadios() {
    const radios = document.querySelectorAll('input[type="radio"]');
    radios.forEach(radio => {
        radio.addEventListener('change', () => {
            localStorage.setItem(radio.name, radio.value);
        });
    });
}

// === RESTAURAR SELECCIONES DE RADIO ===
function restaurarSeleccionRadios() {
    const radios = document.querySelectorAll('input[type="radio"]');
    radios.forEach(radio => {
        const valorGuardado = localStorage.getItem(radio.name);
        if (valorGuardado && radio.value === valorGuardado) {
            radio.checked = true;
        }
    });
}

function cambiarIdioma(idioma) {
  idiomaActual = idioma;
  const t = traducciones[idiomaActual];
  idioma = idiomaActual;

  limpiarCamposTexto();

  // Header y t√≠tulo de la ventana
  document.getElementById("titulo-encuesta").textContent = t.header;
  document.getElementById("title-window").textContent = t.titulo;
  document.title = t.titulo;

  // Labels de campos
  document.getElementById("label-nombre").textContent = idiomaActual === "es" ? "Nombre:" : idiomaActual === "en" ? "Name:" : "Nom:";
  document.getElementById("label-lugar").textContent = idiomaActual === "es" ? "Lugar:" : idiomaActual === "en" ? "Place:" : "Lieu:";
  document.getElementById("label-fecha").textContent = idiomaActual === "es" ? "Fecha:" : idiomaActual === "en" ? "Date:" : "Date:";
  document.getElementById("label-tour").textContent = idiomaActual === "es" ? "Tour:" : idiomaActual === "en" ? "Tour:" : "Tour:";
  document.getElementById("label-operador").textContent = idiomaActual === "es" ? "Operador:" : idiomaActual === "en" ? "Operator:" : "Op√©rateur:";
  document.getElementById("label-conductor").textContent = idiomaActual === "es" ? "Conductor:" : idiomaActual === "en" ? "Driver:" : "Conducteur:";
  document.getElementById("label-transporte").textContent = idiomaActual === "es" ? "Transporte:" : idiomaActual === "en" ? "Transport:" : "Transport:";
  document.getElementById("label-alimentos").textContent = idiomaActual === "es" ? "Alimentos:" : idiomaActual === "en" ? "Food:" : "Aliments:";
  document.getElementById("label-comentarios").textContent = idiomaActual === "es" ? "Comentarios (opcional):" : idiomaActual === "en" ? "Comments (optional):" : "Commentaires (optionnel):";

  // Bot√≥n
  document.getElementById("guardarEncuesta").textContent = idiomaActual === "es" ? "Terminar Encuesta" : idiomaActual === "en" ? "Finish Survey" : "Terminer l'enqu√™te";

  // M√°s info
  document.getElementById("titulo-mas-info").textContent = idiomaActual === "es" ? "Obtenga m√°s informaci√≥n" : idiomaActual === "en" ? "Get more information" : "Obtenez plus d'informations";
  document.getElementById("txtOficial").querySelector("a").textContent = idiomaActual === "es" ? "Kichan Bajlum Oficial" : idiomaActual === "en" ? "Kichan Bajlum Official" : "Kichan Bajlum Officiel";
  document.getElementById("txtFacebook").querySelector("a").textContent = idiomaActual === "es" ? "Kichan Bajlum Facebook" : idiomaActual === "en" ? "Kichan Bajlum Facebook" : "Kichan Bajlum Facebook";
  document.getElementById("txtTripadvisor").querySelector("a").textContent = idiomaActual === "es" ? "Kichan Bajlum Tripadvisor" : idiomaActual === "en" ? "Kichan Bajlum Tripadvisor" : "Kichan Bajlum Tripadvisor";

  // --- Actualizar idioma de Flatpickr seg√∫n selecci√≥n ---
if (fp) {
  if (idioma === "es") fp.set("locale", flatpickr.l10ns.es);
  else if (idioma === "en") fp.set("locale", flatpickr.l10ns.en);
  else if (idioma === "fr") fp.set("locale", flatpickr.l10ns.fr);
}
}

// Cambiar texto del overlay seg√∫n idioma seleccionado
if (idioma === "es") {
  document.getElementById("overlay-msg").textContent = "Cargando";
} 
else if (idioma === "en") {
  document.getElementById("overlay-msg").textContent = "Loading";
}
else {
  document.getElementById("overlay-msg").textContent = "Chargement";
}

// Ejecuta al cargar
document.addEventListener("DOMContentLoaded", () => {
    guardarSeleccionRadios();
    restaurarSeleccionRadios();
});

/* ============================================================
   FUNCI√ìN PARA CAMBIAR IDIOMA ‚Äî REQUERIDA PARA QUE NO EXPLOTE
============================================================ */
function cambiarIdioma(lang) {
  const t = traducciones[lang];

  // T√çTULOS
  document.getElementById("titulo-encuesta").textContent = t.header;
  document.getElementById("title-window").textContent = t.titulo;

  // LABELS PRINCIPALES
  document.getElementById("label-nombre").textContent =
    lang === "es" ? "Nombre:" :
    lang === "en" ? "Name:"   :
                    "Nom:";
  
  document.getElementById("label-lugar").textContent =
    lang === "es" ? "Lugar:" :
    lang === "en" ? "Place:" :
                    "Lieu:";
  
  document.getElementById("label-fecha").textContent =
    lang === "es" ? "Fecha:" :
    lang === "en" ? "Date:"  :
                    "Date:";

  document.getElementById("label-tour").textContent =
    lang === "es" ? "Tour:" :
    lang === "en" ? "Tour:" :
                    "Tour:";

  document.getElementById("label-operador").textContent =
    lang === "es" ? "Operador:" :
    lang === "en" ? "Operator:" :
                    "Op√©rateur:";

  document.getElementById("label-conductor").textContent =
    lang === "es" ? "Conductor:" :
    lang === "en" ? "Driver:" :
                    "Conducteur:";

  document.getElementById("label-transporte").textContent =
    lang === "es" ? "Transporte:" :
    lang === "en" ? "Transport:" :
                    "Transport:";

  document.getElementById("label-alimentos").textContent =
    lang === "es" ? "Alimentos:" :
    lang === "en" ? "Food:" :
                    "Nourriture:";

  document.getElementById("label-comentarios").textContent =
    lang === "es" ? "Comentarios (opcional):" :
    lang === "en" ? "Comments (optional):" :
                    "Commentaires (facultatif):";

  document.getElementById("guardarEncuesta").textContent =
    lang === "es" ? "Terminar Encuesta" :
    lang === "en" ? "Finish Survey" :
                    "Terminer l'enqu√™te";
}

/* ============================================================
   LIMPIAR CAMPOS AL CAMBIAR IDIOMA
============================================================ */
function limpiarCamposTexto() {
  const campos = document.querySelectorAll("input[type='text'], textarea");

  campos.forEach(c => {
    // SI es el campo de fecha, NO lo borres
    if (c.id === "fecha") return;

    // Limpia los dem√°s
    c.value = "";
  });

  // Limpia tambi√©n los radios y checkboxes seleccionados
  const seleccionables = document.querySelectorAll("input[type='radio'], input[type='checkbox']");
  seleccionables.forEach(s => s.checked = false);
}

// --- GUARDAR SELECCIONES ---
function saveFormState() {
    const elements = document.querySelectorAll("input, select, textarea");

    elements.forEach(el => {
        if (el.type === "radio" || el.type === "checkbox") {
            localStorage.setItem(el.id, el.checked);
        } else {
            localStorage.setItem(el.id, el.value);
        }
    });
}

// --- CARGAR SELECCIONES ---
function loadFormState() {
    const elements = document.querySelectorAll("input, select, textarea");

    elements.forEach(el => {
        const stored = localStorage.getItem(el.id);

        if (stored === null) return;

        if (el.type === "radio" || el.type === "checkbox") {
            el.checked = stored === "true";
        } else {
            el.value = stored;
        }
    });
}

// --- GUARDAR AUTOM√ÅTICAMENTE CADA VEZ QUE TOCAN ALGO ---
document.addEventListener("change", saveFormState);

// --- CARGAR AL ABRIR LA P√ÅGINA ---
window.addEventListener("DOMContentLoaded", loadFormState);

function resetearFormularioCompleto() {

  // Limpia textos de inputs y textareas
  document.querySelectorAll("input, textarea").forEach(el => {
    el.value = "";
    el.style.height = "auto"; // reset del autoexpand
  });

  // Limpia selecci√≥n de botones tipo encuesta
  document.querySelectorAll(".btn-group button").forEach(btn => {
    btn.classList.remove("selected");
  });

  // Oculta todos los mensajes de error
  document.querySelectorAll(".error-msg").forEach(err => {
    err.style.display = "none";
  });

  // Quita estilos de error
  document.querySelectorAll(".input-error").forEach(el => {
    el.classList.remove("input-error");
  });
  document.querySelectorAll(".group-error").forEach(el => {
    el.classList.remove("group-error");
  });

  // Limpia TODO el almacenamiento
  localStorage.clear();
}


// === BOT√ìN: VOLVER A IDIOMA ===
document.getElementById("volver-idioma").addEventListener("click", () => {

  // Mostrar selecci√≥n de idioma
  document.getElementById("pantalla-idioma").style.display = "flex";
  document.getElementById("main-encuesta").style.display = "none";

  // üî• Limpia todo al 100%
  resetearFormularioCompleto();
});

// üëá Inicializa Flatpickr apenas cargue la p√°gina
document.addEventListener("DOMContentLoaded", () => {
    window.fpFecha = flatpickr("#fecha", {
        dateFormat: "d/m/Y",
        locale: flatpickr.l10ns.es
    });
});

document.getElementById("idioma")?.addEventListener("change", function () {
    const lang = this.value;
    localStorage.setItem("lang", lang);

    // Reinit del calendario
    flatpickr("#fecha", {
        locale: lang === "es" ? "es" : "en",
        dateFormat: "Y-m-d",
        defaultDate: new Date()
    });
});

  document.addEventListener("DOMContentLoaded", () => {
  });

/* ---------- inicializaci√≥n √∫nica y fija de flatpickr ---------- */
(function() {
  // Aseg√∫rate de ejecutar esto cuando el DOM est√© listo
  document.addEventListener("DOMContentLoaded", () => {

    // Funci√≥n que (re)inicia flatpickr en #fecha con la localizaci√≥n pasada
    function crearFlatpickr(local) {
      // Si ya existe, destr√∫yelo para evitar duplicados
      if (window.fpFecha && typeof window.fpFecha.destroy === "function") {
        try { window.fpFecha.destroy(); } catch(e){ /* no importa */ }
      }

      // Inicializa y guarda la instancia globalmente
      window.fpFecha = flatpickr("#fecha", {
        dateFormat: "d/m/Y",      // formato interno
        altInput: true,           // campo alterno para mostrar bonito
        altFormat: "d/m/Y",       // formato visible
        defaultDate: new Date(),  // pone hoy como valor inicial (as√≠ aparece el a√±o)
        allowInput: true,
        locale: local || "es",    // 'es','en' o 'fr'
        onReady: function(selectedDates, dateStr, instance) {
          // Si el campo aparece vac√≠o por CSS u overlay, forzamos que muestre el altInput value
          try {
            instance.input.value = instance.altInput ? instance.altInput.value : dateStr;
          } catch(e){ /* noop */ }
          console.log("flatpickr listo:", local);
        },
        onOpen: function() {
          // √∫til para pruebas: abre y asegura que el encabezado del calendario tenga texto
          setTimeout(()=> {
            const yearEl = document.querySelector(".flatpickr-current-month .numInputWrapper input.cur-year");
            if (yearEl && yearEl.value === "") {
              // forzamos el a√±o a mostrar si por alg√∫n motivo est√° vac√≠o
              yearEl.value = (new Date()).getFullYear();
            }
          }, 50);
        }
      });
    }

    // Al inicio, crea con espa√±ol por defecto
    crearFlatpickr("es");

    // Cuando el usuario elige idioma (ya tienes botones con data-lang)
    document.querySelectorAll("#pantalla-idioma button").forEach(b => {
      b.addEventListener("click", () => {
        const lang = b.dataset.lang || "es";

        // traducir textos ya lo manejas con cambiarIdioma(), solo reiniciamos flatpickr
        // flatpickr admite strings 'es'/'en'/'fr' si las localizaciones fueron cargadas
        crearFlatpickr(lang);
      });
    });

  }); // DOMContentLoaded
})(); 

const fechaInput = document.getElementById("fecha");

const fp = flatpickr(fechaInput, {
  dateFormat: "Y-m-d",
  defaultDate: new Date(),
  locale: "es"  // idioma inicial
});

function limpiarCamposTexto() {
    const inputs = document.querySelectorAll("input, textarea, select");

    inputs.forEach(el => {
        // NO borrar la fecha
        if (el.id === "fecha" || el.name === "fecha") return;

        // Radio y checkbox se desmarcan
        if (el.type === "radio" || el.type === "checkbox") {
            el.checked = false;
        }
        // Todo lo dem√°s se vac√≠a
        else {
            el.value = "";
        }
    });
}

});

</script>

<script>
  
document.addEventListener("DOMContentLoaded", () => {

    // ---- LISTENERS SEGUROS ----
    document.getElementById("volver-idioma")?.addEventListener("click", () => {
        // c√≥digo aqu√≠
    });

    document.getElementById("btn-es")?.addEventListener("click", () => {
        cambiarIdioma("es");
    });

    document.getElementById("btn-en")?.addEventListener("click", () => {
        cambiarIdioma("en");
    });

    document.getElementById("btn-fr")?.addEventListener("click", () => {
        cambiarIdioma("fr");
    });

    // ---- FLATPICKR ----
    const fp = flatpickr("#fecha", {
        dateFormat: "Y-m-d",
        locale: "es"
    });

    // ---- FUNCI√ìN PARA CAMBIAR IDIOMA ----
    function cambiarIdioma(idioma) {
        console.log("cambiando a:", idioma);

        fp.set("locale", idioma);  // YA NO SE ROMPE
    }

});

</script>

<!-- CONFIRMADOR PERSONALIZADO -->
<div id="confirmador" class="confirm-overlay" style="display:none;">
  <div class="confirm-box">
    <h3>¬øDesea continuar?</h3>
    <div class="confirm-btns">
      <button id="btnConfirmar" class="btn-verde">Continuar</button>
      <button id="btnCancelar" class="btn-rojo">Cancelar</button>
    </div>
  </div>
</div>

</body>
</html>