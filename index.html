<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title id="title-window">Encuesta de Satisfacci√≥n</title>
<link rel="icon" type="image/jpeg" href="a.jpg">

<style>
  
  body {
    font-family: Arial, sans-serif;
    background-color: #d4f0d4;
    margin: 0;
    padding: 0;
    font-size: 16px;
  }

  /* Overlay */
 #overlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background-color: rgba(212,240,212,0.9);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:9998;
    font-size:24px;
    color:#4CAF50;
  }

  .overlay-content {
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
  }

  .icono svg { width:48px; height:48px; }

  .barra {
    width:100px; height:6px;
    background:#c0f0c2;
    border-radius:3px;
    margin:10px 0;
    overflow:hidden;
  }

  .progreso {
    width:50%;
    height:100%;
    background:#2e7d32;
    animation:carga 1s infinite alternate;
  }
  @keyframes carga { from{width:10%} to{width:90%} }

  #overlay-msg {
  color: #2e7d32;   /* verde fijo y consistente */
  font-weight: bold;
  }

  /* Pantalla de idioma */
  #pantalla-idioma {
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background-color: #d4f0d4;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }

  #pantalla-idioma h2 { font-size:28px; margin-bottom:30px; text-align:center; }

  #pantalla-idioma button {
    padding:15px 25px;
    margin:10px;
    font-size:18px;
    border:none;
    border-radius:5px;
    cursor:pointer;
    background-color:#4CAF50;
    color:white;
    transition:0.2s;
  }

  #pantalla-idioma button:hover { background-color:#45a049; }

  #pantalla-idioma h2 {
  font-size:28px;
  margin: 0;          /* üî• mata todo el espacio */
  line-height: 1.2;  /* compacto pero legible */
  text-align:center;
}

  header {
    background-color:#4CAF50;
    height:100px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    padding:0 15px;
    position:relative;
  }

  header .header-content { display:flex; align-items:center; gap:10px; }
  header img { height:80px; width:auto; }
  header h1 { color:white; font-size:30px; margin:0; text-align:center; }
  #volver-idioma { cursor:pointer; fill:white; width:40px; height:40px; }

  main {
    max-width:600px;
    margin:20px auto;
    padding:1em;
    background:white;
    border-radius:10px;
    box-shadow:0 0 10px rgba(0,0,0,0.1);
    display:none;
  }

  label { display:block; margin-top:10px; font-weight:bold; }
  input, textarea, select {
    width:100%;
    padding:8px;
    margin-top:5px;
    border-radius:5px;
    border:1px solid #ccc;
    box-sizing:border-box;
    resize:none;
    overflow:visible;
  }
  .autoexpand { overflow:hidden; }

/* üåÆ UNIFORMIDAD VISUAL PARA TODOS LOS CAMPOS üòÑ */
:root {
  --alto-campo: 42px; /* üü© Altura est√°ndar para todos los campos */
}

/* üì± Inputs, selects, tel√©fono y flatpickr: todos igualitos */
input,
select,
.flatpickr-alt-input,
.iti input {
  height: var(--alto-campo) !important;
  box-sizing: border-box;
}

:root {
  --alto-campo: 42px;
}

input,
select,
.flatpickr-alt-input,
.iti input {
  height: var(--alto-campo) !important;
  padding: 8px 10px;
  box-sizing: border-box;
}

  .btn-group {
    display:flex;
    justify-content:space-between;
    margin-top:5px;
  }
  
  .btn-group button {
  flex: 1;
  margin-right: 5px;

  /* üî• IGUAL QUE INPUTS */
  height: 42px;
  padding: 8px 10px;
  box-sizing: border-box;
  line-height: normal;

  font-family: Arial, sans-serif;
  font-size: 16px;
  font-weight: normal; /* ‚Üê este era el culpable */

  border-radius: 5px;
  border: 1px solid #4CAF50;
  background: white;
  color: #4CAF50;

  cursor: pointer;
  transition: 0.2s;
}

  .btn-group button:last-child { margin-right:0; }
  .btn-group button.selected { background:#4CAF50; color:white; }

  button#guardarEncuesta {
    background-color:#4CAF50;
    color:white;
    border:none;
    padding:10px 20px;
    margin-top:15px;
    cursor:pointer;
    border-radius:5px;
    font-size:16px;
    width:100%;
  }

  button#guardarEncuesta:hover { background-color:#45a049; }

  #mas-info a { color:#007bff; text-decoration:none; font-weight:bold; }

.error-msg {
  color: red;
  font-size: 14px;
  margin-top: 5px;
  display: none; /* Oculto por defecto */
}

.field-error {
  border: 2px solid red !important;
}

.confirm-overlay {
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
}

.confirm-box {
  background:white;
  padding:25px;
  border-radius:10px;
  text-align:center;
  width:80%;
  max-width:350px;
}

.btn-verde {
  background:#4CAF50;
  color:white;
  padding:10px 20px;
  border:none;
  margin:10px;
  cursor:pointer;
  border-radius:5px;
}

.btn-rojo {
  background:#e53935;
  color:white;
  padding:10px 20px;
  border:none;
  margin:10px;
  cursor:pointer;
  border-radius:5px;
}

.group-error {
  border: 2px solid #ff4d4d !important;
  border-radius: 8px;
  padding: 5px;
  animation: glowError 0.6s ease-in-out infinite alternate;
}

@keyframes glowError {
  from { box-shadow: 0 0 5px rgba(255, 77, 77, 0.5); }
  to   { box-shadow: 0 0 14px rgba(255, 0, 0, 0.9); }
}

.input-error {
  border: 2px solid #ff4d4d !important;
  border-radius: 6px;
  animation: glowInput 0.6s ease-in-out infinite alternate;
}

@keyframes glowInput {
  from { box-shadow: 0 0 5px rgba(255, 77, 77, 0.4); }
  to   { box-shadow: 0 0 12px rgba(255, 0, 0, 0.9); }
}

#mensaje-estado {
  width: 100%;
  text-align: center;
  padding: 12px;
  font-size: 18px;
  font-weight: bold;
  border-radius: 6px;
  display: none;
  margin-bottom: 15px;
}

.msg-ok {
  background: #4CAF50;
  color: white;
  display: block !important;
}

.msg-error {
  background: #e53935;
  color: white;
  display: block !important;
}

/* üîí INPUTS = UNA SOLA L√çNEA, ESTILO intl-tel-input */
input,
select,
.flatpickr-alt-input,
.iti input {
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: clip !important;
  line-height: normal !important;
  height: 42px !important;
  box-sizing: border-box;
}

.pdf-campo {
  display: block;
  width: 100%;
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: anywhere;
  font-family: inherit;
  font-size: 14px;
  line-height: 1.6;          /* üëà m√°s aire entre l√≠neas */
  padding: 6px 8px 14px;     /* üëà espacio extra abajo */
  margin-bottom: 12px;       /* üëà colch√≥n antes de posible salto */
  border-bottom: 1px solid #999;
  min-height: 20px;
}

.error-campo {
  background: #fdecea;
  color: #c62828;
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 14px;
  margin-bottom: 8px;
  text-align: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

.error-campo.hidden {
  display: none;
}

/* ===== intl-tel-input: alineaci√≥n PERFECTA ===== */
.iti input {
  font: inherit;
  padding: 8px;
  line-height: normal;
  box-sizing: border-box;
}

.iti {
  width: 100%;
}

.iti__selected-flag {
  height: 100%;
  display: flex;
  align-items: center;
}

.campo-telefono {
  margin-bottom: 16px; /* usa el mismo valor que los otros campos */
}

.campo-telefono label {
  display: block;
  margin-bottom: 6px;
}

/* Igualar espacio entre label y campo de tel√©fono */
#label-telefono {
  display: block;
  margin-bottom: 6px;
}

/* Evitar que intl-tel-input meta espacio extra */
.iti {
  margin-top: 0;
}

/* ===== FUENTE GLOBAL (TODO) ===== */
body {
  font-family: Arial, sans-serif;
}

/* ===== EXCEPCIONES: NO TOCAR ===== */

/* intl-tel-input (tel√©fono completo) */
.iti,
.iti * {
  font-family: inherit !important;
}

/* ===== TEXTO ESCRITO: MISMA LETRA QUE TODO ===== */
input,
textarea,
select,
.iti input {
  font-family: Arial, sans-serif !important;
}

input[type="email"] {
  font-family: Arial, sans-serif !important;
}

/* SOLO el input visible */
.flatpickr-alt-input {
  font-family: Arial, sans-serif;
  font-size: 16px;
  height: 42px;
  padding: 8px 10px;
  box-sizing: border-box;
}

textarea.autoexpand {
  min-height: 42px;
  height: 42px;
  padding: 8px 10px;
  line-height: normal !important; /* üîë CLAVE */
  overflow-y: hidden;
  resize: none;
  box-sizing: border-box;
}

/* ===== FUENTE √öNICA GLOBAL Y DEFINITIVA ===== */
body,
input,
textarea,
select,
button {
  font-family: Arial, sans-serif !important;
  font-size: 16px !important;
}

/* ===== FLATPICKR EXACTO AL TEL√âFONO ===== */
.flatpickr-input,
.flatpickr-alt-input,
.flatpickr-input[readonly],
.flatpickr-alt-input[readonly] {
  font-family: Arial, sans-serif !important;
  font-size: 16px !important;
  height: 42px !important;
  padding: 8px 10px !important;
  line-height: normal !important;
  box-sizing: border-box;
}

#comentarios {
  min-height: calc(4 * 1.4em + 16px); /* 4 filas reales */
  height: 42px;              /* arranca igual que los dem√°s */
  overflow-y: hidden;        /* üö´ PROH√çBE scroll interno */
  resize: none;
}

/* ===== flatpickr: NO aplicar reglas globales ===== */
.flatpickr-calendar select,
.flatpickr-calendar input {
  height: auto !important;
  padding: 0 !important;
  font-size: inherit;
  line-height: normal;
}

/* Encabezado mes + a√±o alineados */
.flatpickr-current-month {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

/* Mes visible correctamente */
.flatpickr-monthDropdown-months {
  height: auto !important;
  padding: 0 4px !important;
}

/* A√±o sin recorte */
.flatpickr-current-month input.cur-year {
  height: auto !important;
  padding: 0 2px !important;
}

/* ===== BOTONES DE OPCIONES: ANIMACI√ìN ORIGINAL ===== */
.btn-group button {
  transition:
    background-color 0.25s ease,
    color 0.25s ease,
    transform 0.15s ease,
    box-shadow 0.15s ease;
}

/* Hover */
.btn-group button:hover {
  background-color: #e8f5e9;
}

/* Click real */
.btn-group button:active {
  transform: scale(0.96);
}

/* Seleccionado */
.btn-group button.selected {
  background-color: #4CAF50;
  color: white;
  box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4);
  transform: scale(1.02);
}

#correoelectr√≥nico {
  height: 42px;
  padding: 8px 10px;
  box-sizing: border-box;
}

#fecha,
.flatpickr-alt-input {
  caret-color: transparent;
  user-select: none;
}

/* üì± Overlay: texto perfectamente centrado en m√≥viles */
#overlay-msg {
  width: 100%;
  max-width: 90%;
  text-align: center;
  margin: 0 auto;
  line-height: 1.4;
}

/* üìÑ PDF: im√°genes centradas SIEMPRE */
.pdf-campo img,
img.pdf-img {
  display: block !important;
  margin: 10px auto !important;
  max-width: 100%;
}

.iti {
  width: 100%;
}

.iti input {
  height: 42px;
  padding: 8px 10px;
  line-height: normal;   /* üî• clave */
  font-weight: normal;
  box-sizing: border-box;
  font-family: inherit;
}

.iti__flag-container {
  display: flex;
  align-items: center;
}

label + .iti,
label + input {
  margin-top: 6px;
}

/* ===== PDF: textarea como texto limpio ===== */
.pdf-campo {
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: anywhere;
  line-height: 1.6;
  padding: 6px 8px 14px;
  margin-bottom: 12px;
  border-bottom: 1px solid #999;
  min-height: 20px;
}

/* üî• TEXTO ID√âNTICO EN INPUT Y TEXTAREA */
input,
textarea {
  font-family: "Inter", Arial, sans-serif !important;
  font-size: 16px !important;
  line-height: normal !important;
}

/* === UNIFICAR TODOS LOS CAMPOS === */
input,
textarea,
.flatpickr-input {
  width: 100%;
  height: 44px;
  padding: 10px 12px;
  font-family: Arial, sans-serif;
  font-size: 16px;
  line-height: 1.4;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-sizing: border-box;
  background: #fff;
}

/* Textarea igual al input */
textarea {
  min-height: 44px;
  resize: vertical;
}

/* Flatpickr (fecha) */
.flatpickr-input {
  background-color: #fff !important;
}

/* Quitar estilos raros del navegador */
input:invalid,
textarea:invalid {
  box-shadow: none !important;
  outline: none !important;
}

/* Error visual controlado */
.campo-error {
  border: 2px solid red !important;
}

</style>
</head>

<body>

<!-- Overlay -->
<div id="overlay">
  <div class="overlay-content">
    <div class="icono">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48">
        <path fill="#2e7d32" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5 14.5 7.62 14.5 9 13.38 11.5 12 11.5z"/>
      </svg>
    </div>
    <div class="barra">
      <div class="progreso"></div>
    </div>
    <p id="overlay-msg">Cargando...</p>
  </div>
</div>

<!-- Pantalla de idioma -->
<div id="pantalla-idioma">

<img src="a.jpg" alt="Kichan Bajlum" style="width: 160px; margin-bottom:30px;">

  <h2 id="pantalla-idioma-es">Seleccione su idioma</h2>
<h2 id="pantalla-idioma-en">Select your language</h2>
<h2 id="pantalla-idioma-fr">S√©lectionnez votre langue</h2>

  <div style="height:20px;"></div> <!-- üëà l√≠nea vac√≠a -->

  <button data-lang="es">Espa√±ol</button>
  <button data-lang="en">English</button>
  <button data-lang="fr">Fran√ßais</button>

</div>

<header>
  <div class="header-content">
    <svg id="volver-idioma" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M15 6l-6 6 6 6" stroke-width="2" stroke="white" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <img src="a.jpg" alt="Logo">
    <h1 id="titulo-encuesta">Encuesta de Satisfacci√≥n</h1>
  </div>
</header>

<main id="main-encuesta">

  <div id="mensaje-estado"></div>

  <form id="encuestaForm" autocomplete="off" novalidate>

    <label id="label-nombre" for="nombre">Nombre:</label>
    <textarea id="nombre" name="nombre" class="autoexpand" rows="1" autocomplete="off"></textarea>
    <div class="error-msg" id="error-nombre"></div>

    <label for="telefono" id="label-telefono">N√∫mero telef√≥nico</label>

<input
  id="telefono"
  type="tel"
  inputmode="tel"
  autocomplete="off"
/>

<div class="error-msg" id="error-telefono"></div>

<div id="telefono-pdf" style="display:none;"></div>

    <label id="label-correo" for="correoelectr√≥nico">Correo electr√≥nico:</label>

<input
  type="email"
  id="correoelectr√≥nico"
  autocomplete="off"
/>

<div class="error-msg" id="error-correo"></div>

    <label id="label-lugar" for="lugar">Lugar:</label>
    <textarea id="lugar" name="lugar" class="autoexpand" rows="1" autocomplete="off"></textarea>
    <div class="error-msg" id="error-lugar"></div>

    <label id="label-fecha" for="fecha">Fecha:</label>

    <input
  type="text"
  id="fecha"
  name="fecha"
  autocomplete="off"
  readonly
  inputmode="none"
>

    <div class="error-msg" id="error-fecha"></div>

    <label id="label-tour" for="tour">Tour:</label>
    <textarea id="tour" name="tour" class="autoexpand" rows="1" autocomplete="off" ></textarea>
    <div class="error-msg" id="error-tour"></div>

    <label id="label-conductor">Conductor:</label>
    <div class="btn-group" data-field="conductor">
      <button type="button">Excelente</button>
      <button type="button">Bueno</button>
      <button type="button">Regular</button>
      <button type="button">Malo</button>
    </div>

    <label id="label-transporte">Transporte:</label>
    <div class="btn-group" data-field="transporte">
      <button type="button">Excelente</button>
      <button type="button">Bueno</button>
      <button type="button">Regular</button>
      <button type="button">Malo</button>
    </div>

    <label id="label-alimentos">Alimentos:</label>
    <div class="btn-group" data-field="alimentos">
      <button type="button">Excelente</button>
      <button type="button">Bueno</button>
      <button type="button">Regular</button>
      <button type="button">Malo</button>
    </div>

    <label id="label-comentarios" for="comentarios">Comentarios (opcional):</label>
    <textarea id="comentarios" name="comentarios" class="autoexpand" rows="4" autocomplete="off"></textarea>

    <button type="button" id="guardarEncuesta">Terminar Encuesta</button>
  </form>

  <hr style="margin:30px 0;">
  <section id="mas-info" style="text-align:center; padding:20px; background-color:#e8f5e9; border-radius:10px;">
    <h2 id="titulo-mas-info">Obtenga m√°s informaci√≥n</h2>
    <div style="display:flex; justify-content:space-around; flex-wrap:wrap; margin-top:20px; gap:20px;">
      <div>
        <img src="QR1.png" alt="QR Kichan Bajlum Oficial" width="200" height="200">
        <p id="txtOficial"><a href="https://www.kichantravel.com/" target="_blank">Kichan Bajlum Oficial</a></p>
      </div>
      <div>
        <img src="QR2.png" alt="QR Kichan Bajlum Facebook" width="200" height="200">
        <p id="txtFacebook"><a href="https://www.facebook.com/KichanBajlumOficial/" target="_blank">Kichan Bajlum Facebook</a></p>
      </div>
      <div>
        <img src="QR3.png" alt="QR Kichan Bajlum Tripadvisor" width="200" height="200">
        <p id="txtTripadvisor"><a href="https://www.tripadvisor.com.mx/Attraction_Review-g249851-d10294242-Reviews-Kichan_Bajlum_Tour_Operator-Palenque_Southern_Mexico.html" target="_blank">Kichan Bajlum Tripadvisor</a></p>
      </div>
    </div>
  </section>
</main>

<link rel="stylesheet" href="https://unpkg.com/flatpickr/dist/flatpickr.min.css">

<script src="https://unpkg.com/flatpickr/dist/flatpickr.min.js"></script>

<!-- Idiomas -->
<script src="https://unpkg.com/flatpickr/dist/l10n/es.js"></script>
<script src="https://unpkg.com/flatpickr/dist/l10n/fr.js"></script>

<!-- Librer√≠a html2pdf (OBLIGATORIA) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js"></script>

<script>

  const inputCorreo = document.getElementById("correoelectr√≥nico");
let correoFueEditado = false;


  // Variables globales
  let iti = null;
  let idiomaActual = "es";
  let inputTelefono = null;
  let ultimoTelefonoValido = "";
  let telefonoFueEditado = false;
  let ultimoValorTelefono = "";

  // Traducciones y mensajes globales
  const traducciones = {
    es: {
      alertaTitulo: "¬øDesea continuar?",
      continuar: "Continuar",
      cancelar: "Cancelar",
      msgCampo: "Por favor, complete este campo.",
      titulo: "Encuesta de Satisfaci√≥n",
      header: "Encuesta de Satisfacci√≥n"
    },
    en: {
      alertaTitulo: "Do you want to continue?",
      continuar: "Continue",
      cancelar: "Cancel",
      msgCampo: "Please, fill out this field.",
      titulo: "Encuesta de Satisfaci√≥n",
      header: "Satisfaction Survey"
    },
    fr: {
      alertaTitulo: "Voulez-vous continuer ?",
      continuar: "Continuer",
      cancelar: "Annuler",
      msgCampo: "Veuillez, remplir ce champ.",
      titulo: "Encuesta de Satisfaci√≥n",
      header: "Enqu√™te de Satisfaction"
    }
  };

  const mensajesTelefono = {
  es: {
    invalido: "Por favor, ingrese un n√∫mero de tel√©fono v√°lido.",
    requerido: "Por favor, complete este campo."
  },
  en: {
    invalido: "Please, enter a valid phone number.",
    requerido: "Please, fill out this field."
  },
  fr: {
    invalido: "Veuillez, saisir un num√©ro de t√©l√©phone valide.",
    requerido: "Veuillez, remplir ce champ."
  }
};

const correoInvalido = {
  es: "Ingrese un correo electr√≥nico v√°lido.",
  en: "Please enter a valid email address.",
  fr: "Veuillez saisir une adresse e-mail valide."
};

const correoVacio = {
  es: "Por favor, complete este campo.",
  en: "Please, fill out this field.",
  fr: "Veuillez, remplir ce champ."
};

const opciones = {
  es: ["Excelente", "Bueno", "Regular", "Malo"],
  en: ["Excellent", "Good", "Average", "Bad"],
  fr: ["Excellent", "Bon", "Moyen", "Mauvais"]
};

  // Funci√≥n global para prefijo
  function fijarPrefijoActual() {
    if (!iti) return;
    if (!inputTelefono.value) inputTelefono.value = "+";
  }

  function paisInicialPorIdioma(idioma) {
  if (!iti) return;

  let countryCode;
  switch (idioma) {
    case "es": countryCode = "mx"; break;
    case "en": countryCode = "us"; break;
    case "fr": countryCode = "fr"; break;
  }

  iti.setCountry(countryCode);

  const data = iti.getSelectedCountryData();
  inputTelefono.value = "+" + (data?.dialCode || "52");

  aplicarLimitePorPais(); // üî• PASO 2 ‚Äì parte B
  }

  document.addEventListener("DOMContentLoaded", () => {

inputCorreo.addEventListener("keydown", e => {
  if (e.key === "Enter") e.preventDefault();
});

inputCorreo.addEventListener("input", () => {
  correoFueEditado = true;

  let v = inputCorreo.value;

  // quitar acentos
  v = v.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

  // quitar espacios y saltos
  v = v.replace(/[\s\r\n]+/g, "");

  // solo caracteres v√°lidos
  v = v.replace(/[^a-zA-Z0-9@._+-]/g, "");

  // solo UN @
  const partes = v.split("@");
  if (partes.length > 2) {
    v = partes[0] + "@" + partes.slice(1).join("");
  }

  // NO cortar dominios modernos
v = v.replace(/(\.[a-zA-Z]{2,}).*$/i, "$1");


  // no .. seguidos
  v = v.replace(/\.{2,}/g, ".");

  // no @ al inicio
  v = v.replace(/^@+/, "");

  inputCorreo.value = v;
});

inputCorreo.addEventListener("blur", () => {
  validarCorreo(false);
});

  inputTelefono = document.getElementById("telefono");

  iti = window.intlTelInput(inputTelefono, {
    initialCountry: "mx",
    nationalMode: false,
    separateDialCode: false,
    autoPlaceholder: "off",
    formatOnDisplay: false,
    preferredCountries: ["mx", "us", "fr"],
    utilsScript:
      "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js",
  });

  // üî• aplicar l√≠mite inicial por pa√≠s
  setTimeout(aplicarLimitePorPais, 0);

  // üî• cuando cambia la bandera / pa√≠s
  inputTelefono.addEventListener("countrychange", () => {
  telefonoFueEditado = true;        // üî• ahora cuenta como edici√≥n
  aplicarLimitePorPais();
});

  inputTelefono.addEventListener("blur", () => {
    validarTelefonoEnVivo(false);
  });

  // Regla de oro: edit√≥ una vez = editado para siempre
  telefonoFueEditado = false;
  inputTelefono.addEventListener("input", () => {
    telefonoFueEditado = true;

    // L√≥gica de reconstrucci√≥n del valor
    let valor = inputTelefono.value;
    if (!valor.startsWith("+")) {
      valor = "+" + valor.replace(/\+/g, "");
    }
    let numeros = valor.slice(1).replace(/\D/g, "");
    const maxNacional = Number(inputTelefono.dataset.maxDigitos);
    const data = iti.getSelectedCountryData();
    const dial = data && data.dialCode ? data.dialCode : "";
    const limiteTotal = 1 + dial.length + maxNacional;
    let reconstruido = "+" + numeros;
    if (reconstruido.length > limiteTotal) {
      reconstruido = reconstruido.slice(0, limiteTotal);
    }
    inputTelefono.value = reconstruido;
  });

// ------------------- FIN BLOQUE TELEFONO -------------------

const traduccionesPaises = {
  es: { Mexico: "M√©xico", France: "Francia" },
  en: { Mexico: "Mexico", France: "France" },
  fr: { Mexico: "Mexique", France: "France" }
};

  /*=============================================================
   TRADUCCIONES
============================================================ */
document.title = "Encuesta de Satisfacci√≥n"; // siempre en espa√±ol en la selecci√≥n

const idiomaConfig = {
  es: {
    country: "mx",
    lang: "es",
    error: "N√∫mero de tel√©fono inv√°lido",
    label: "N√∫mero telef√≥nico"
  },
  en: {
    country: "us",
    lang: "en",
    error: "Invalid phone number",
    label: "Phone number"
  },
  fr: {
    country: "fr",
    lang: "fr",
    error: "Num√©ro de t√©l√©phone invalide",
    label: "Num√©ro de t√©l√©phone"
  }
};

  });


function actualizarTelefonoHint(idioma) {
  const hint = document.getElementById("telefono-hint");
  if (hint) hint.textContent = telefonoHintTexto[idioma] || telefonoHintTexto.es;
}

    document.title = "Encuesta de Satisfacci√≥n";
document.getElementById("title-window").textContent = "Encuesta de Satisfacci√≥n";

    window.fpFecha = null;

function add(id, event, handler) {
  const el = document.getElementById(id);
  if (!el) {
    console.warn("Elemento no encontrado:", id);
    return;
  }
  el.addEventListener(event, handler);
}

function mostrarErrorCorreo(texto) {
  const error = document.getElementById("error-correo");
  const input = document.getElementById("correoelectr√≥nico");

  if (!error || !input) return;

  error.textContent = texto;
  error.style.display = "block";
  input.classList.add("input-error");
}

function ocultarErrorCorreo() {
  const error = document.getElementById("error-correo");
  const input = document.getElementById("correoelectr√≥nico");

  if (error) error.style.display = "none";
  if (input) input.classList.remove("input-error");
}

// === VALIDAR CORREO ===
function validarCorreo(forzar = false) {
  const correo = inputCorreo.value.trim();

  if (!correoFueEditado && !forzar) {
    ocultarErrorCorreo();
    return true;
  }

  if (correo === "") {
    if (forzar) {
      mostrarErrorCorreo(correoVacio[idiomaActual]);
      return false;
    }
    ocultarErrorCorreo();
    return true;
  }

  const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

  if (!regex.test(correo)) {
    mostrarErrorCorreo(correoInvalido[idiomaActual]);
    return false;
  }

  ocultarErrorCorreo();
  return true;
}

// === OBTENER TEL√âFONO FINAL UNIDO ===
function obtenerTelefonoFinal() {
  return iti.getNumber(); // üëâ +5219161172035
}

  function mensajeOK() {
  const box = document.getElementById("mensaje-estado");
  box.className = "msg-ok";
  box.textContent = "Encuesta enviada correctamente";
  box.style.display = "block";
  setTimeout(() => box.style.display = "none", 3000);
}

function mensajeERROR() {
  const box = document.getElementById("mensaje-estado");
  box.className = "msg-error";
  box.textContent = "Error al enviar encuesta";
  box.style.display = "block";
  setTimeout(() => box.style.display = "none", 3000);
}

/* ============================================================
   AUTOEXPAND
============================================================ */
function autoExpand(el) {
  el.style.height = "42px";          // reset real
  el.style.height = el.scrollHeight + "px";
}

document.querySelectorAll(".autoexpand").forEach(area => {
  autoExpand(area);

  area.addEventListener("input", () => {
    autoExpand(area);
  });
});

document.querySelectorAll("#pantalla-idioma button").forEach(boton => {
  boton.addEventListener("click", () => {

    idiomaActual = boton.dataset.lang;
    lang = idiomaActual; // Actualiza la global para compatibilidad
    paisInicialPorIdioma(idiomaActual);

    document.getElementById("pantalla-idioma").style.display = "none";
    document.getElementById("main-encuesta").style.display = "block";
    document.getElementById("overlay").style.display = "none";

    document.title = "Encuesta de Satisfacci√≥n";

    cambiarIdioma(idiomaActual);
  });
});

function limpiarFormulario() {
  // Campos de texto y textarea
  ["nombre", "telefono", "correoelectr√≥nico", "lugar", "fecha", "tour", "comentarios"].forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      campo.value = "";
      campo.style.height = "auto"; // reset del autoexpand
    }
  });

  // Botones seleccionados
  document.querySelectorAll(".btn-group button.selected").forEach(btn => {
    btn.classList.remove("selected");
  });

  // Borrar mensajes de error
  document.querySelectorAll(".error-msg").forEach(err => {
    err.style.display = "none";
  });

  // Quitar efectos de error
  document.querySelectorAll(".input-error").forEach(el => {
    el.classList.remove("input-error");
  });

  document.querySelectorAll(".group-error").forEach(el => {
    el.classList.remove("group-error");
  });
}

/* ============================================================
   VALIDACI√ìN
============================================================ */
function validarCampos() {
  if (typeof traducciones === 'undefined') {
    console.error('traducciones no est√° definida');
    return false;
  }
  const t = traducciones[idiomaActual];
  let ok = true;

  // CAMPOS DE TEXTO
  const camposTexto = ["nombre", "lugar", "fecha", "tour"];

  camposTexto.forEach(id => {
    let campo = document.getElementById(id);
    let error = document.getElementById("error-" + id);

if (!campo.value.trim()) {
  ok = false;
  campo.classList.add("input-error");

  if (!error) {
    error = document.createElement("div");
    error.id = "error-" + id;
    error.className = "error-msg";
    campo.insertAdjacentElement("afterend", error);
  }

  error.textContent = t.msgCampo;
  error.style.display = "block";
} else {
  campo.classList.remove("input-error");
  if (error) error.style.display = "none";
}
  });

  // CAMPOS DE OPCIONES (BOTONES)
  const grupos = ["conductor", "transporte", "alimentos"];

  grupos.forEach(id => {
    const group = document.querySelector(`.btn-group[data-field="${id}"]`);
    const seleccionado = group.querySelector(".selected");

    const msg = (idiomaActual === "es")
      ? "Por favor, seleccione una opci√≥n."
      : (idiomaActual === "en")
        ? "Please select an option."
        : "Veuillez s√©lectionner une option.";

    if (!seleccionado) {
      ok = false;

      group.classList.add("group-error");

      let err = document.getElementById("error-" + id);
      if (!err) {
        err = document.createElement("div");
        err.id = "error-" + id;
        err.className = "error-msg";
        group.insertAdjacentElement("afterend", err);
      }

      err.textContent = msg;
      err.style.display = "block";

    } else {
      group.classList.remove("group-error");

      const err = document.getElementById("error-" + id);
      if (err) err.style.display = "none";
    }
  });

  return ok;
}

function telefonoEsValido() {
  if (!iti) return false;
  return iti.isValidNumber();
}

/* ============================================================
   ALERTA PERSONALIZADA ‚Äî FUNCIONAL Y TRADUCIBLE
============================================================ */
function mostrarAlerta(callback) {
  const t = traducciones[idiomaActual];

  document.querySelectorAll(".confirm-overlay").forEach(e => e.remove());

  const overlay = document.createElement("div");
  overlay.className = "confirm-overlay";

  const box = document.createElement("div");
  box.className = "confirm-box";
  box.innerHTML = `
    <h3>${t.alertaTitulo}</h3>
    <button id="btnConfirmar" class="btn-verde">${t.continuar}</button>
    <button id="btnCancelar" class="btn-rojo">${t.cancelar}</button>
  `;

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  document.getElementById("btnConfirmar").onclick = () => {
    overlay.remove();
    callback(true);
  };
  document.getElementById("btnCancelar").onclick = () => {
    overlay.remove();
    callback(false);
  };
}

function prepararCamposParaPDF() {
  const campos = document.querySelectorAll(
    '#encuestaForm textarea, #encuestaForm select'
  );

  campos.forEach(campo => {
    const valor = campo.value || ' ';

    const div = document.createElement('div');
    div.className = 'pdf-campo';
    div.textContent = valor;
    div.dataset.pdfReemplazo = 'true';

    campo.style.display = 'none';
    campo.parentNode.insertBefore(div, campo.nextSibling);
  });
}

/* ============================================================
   ENV√çO REAL
============================================================ */
async function generarYEnviarPDF() {
  mostrarOverlay(mensajesEnvio[idiomaActual].enviando);

    prepararCamposParaPDF();

    const telefonoPDF = document.getElementById("telefono-pdf");

// n√∫mero internacional correcto (+52‚Ä¶)
telefonoPDF.textContent = iti.getNumber();

// ocultar input real
document.querySelector(".iti").style.display = "none";

// mostrar texto plano en PDF
telefonoPDF.style.display = "block";

  try {
const pdf = await html2pdf()
  .from(document.getElementById("encuestaForm"))
  .set({
    margin: [10, 10, 10, 10],
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: {
    scale: 2,
    useCORS: true,
    scrollY: 0,
    windowWidth: document.body.scrollWidth,
    letterRendering: true   // üëà mejora cortes de texto
    },
    jsPDF: {
      unit: "mm",
      format: "a4",
      orientation: "portrait"
    }
  })
  .outputPdf("datauristring");

  restaurarCamposDespuesPDF(); // üî• Y ESTA TAMBI√âN

  setTimeout(() => {
  document.querySelector(".iti").style.display = "";
  telefonoPDF.style.display = "none";
}, 1000);

    const base64 = pdf.split(",")[1];

    await fetch("https://script.google.com/macros/s/AKfycbzTFXLQI5KzzUBNWJnNi8HCz5m7szjdQTY7ReHVe-E0r7EnfAY5PJlC3nt6PtrhGJ_D_Q/exec", {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        archivo: base64,
        nombre: "Encuesta_" + Date.now() + ".pdf"
      })
    });

    setOverlayMensaje(mensajesEnvio[idiomaActual].ok);
    setTimeout(ocultarOverlay, 1500);

  } catch (e) {
    console.error(e);
    setOverlayMensaje(mensajesEnvio[idiomaActual].error);
    setTimeout(ocultarOverlay, 2000);
  }
}

function restaurarCamposDespuesPDF() {
  document.querySelectorAll('[data-pdf-reemplazo]').forEach(div => {
    const campo = div.previousSibling;
    if (campo) campo.style.display = '';
    div.remove();
  });
}

/* =====================================
   VALIDACI√ìN CON TU MISMA ALERTA
===================================== */

function validarTelefonoEnVivo(forzar = false) {
  if (!iti || !inputTelefono) return false;

  const valor = inputTelefono.value.trim();
  const data = iti.getSelectedCountryData() || {};
  const dial = data.dialCode || "";
  const msg = mensajesTelefono[idiomaActual] || mensajesTelefono.es;

  // üö´ blur: si nunca escribi√≥, NO mostrar nada
if (!telefonoFueEditado && !forzar) {
  ocultarErrorTelefono();
  return true;
}

// üî• submit: nunca escribi√≥ ‚Üí requerido
  if (forzar && !telefonoFueEditado) {
    mostrarErrorTelefono(msg.requerido);
    return false;
  }

// üî¥ SOLO prefijo (+ o +52)
if (valor === "" || valor === "+" || valor === `+${dial}`) {
  if (!telefonoFueEditado) {
    mostrarErrorTelefono(msg.requerido);
  } else {
    mostrarErrorTelefono(msg.invalido);
  }
  return false;
}

// üî¥ Escrito pero inv√°lido
if (!iti.isValidNumber()) {
  mostrarErrorTelefono(msg.invalido);
  return false;
}

// ‚úÖ OK
ocultarErrorTelefono();
return true;
}

function mostrarErrorTelefono(texto) {
  const error = document.getElementById("error-telefono");
  const input = document.getElementById("telefono");

  if (!error || !input) return;

  error.textContent = texto;
  error.style.display = "block";
  input.classList.add("input-error");
}

function ocultarErrorTelefono() {
  const error = document.getElementById("error-telefono");
  const input = document.getElementById("telefono");

  if (error) error.style.display = "none";
  if (input) input.classList.remove("input-error");
}

function aplicarLimitePorPais() {
  if (!iti || !window.intlTelInputUtils) return;

  const data = iti.getSelectedCountryData();
  if (!data || !data.iso2) return;

  // üëá ejemplo NACIONAL (SIN prefijo)
  const ejemploNacional = window.intlTelInputUtils.getExampleNumber(
    data.iso2,
    true, // üëà NACIONAL, NO internacional
    window.intlTelInputUtils.numberFormat.NATIONAL
  );

  if (!ejemploNacional) return;

  // SOLO d√≠gitos nacionales
  const soloNacionales = ejemploNacional.replace(/\D/g, "");

  inputTelefono.dataset.maxDigitos = soloNacionales.length;
}

/* ============================================================
   BOT√ìN PRINCIPAL ‚Äî AHORA S√ç FUNCIONA
============================================================ */
document.getElementById("guardarEncuesta").addEventListener("click", () => {


let ok = true;

// 1Ô∏è‚É£ validar tel√©fono (SIEMPRE)
if (!validarTelefonoEnVivo(true)) {
  ok = false;
}

// 2Ô∏è‚É£ validar correo (SIEMPRE)
if (!validarCorreo(true)) {
  ok = false;
}

// 3Ô∏è‚É£ validar dem√°s campos (SIEMPRE)
if (!validarCampos()) {
  ok = false;
}

// 3Ô∏è‚É£ si algo fall√≥ ‚Üí detener
if (!ok) {
  return;
}

  // üî• 3. TODO OK ‚Üí CONFIRMACI√ìN
  mostrarAlerta(async ok => {
    if (!ok) return;

    try {
      await generarYEnviarPDF();

      const terminadoMsg =
        idiomaActual === "es"
          ? "Encuesta terminada correctamente. ¬°Gracias por su tiempo! Ya puede cerrar esta ventana."
          : idiomaActual === "en"
          ? "Survey completed successfully. Thank you! You can now close this window."
          : "Sondage termin√© avec succ√®s. Merci ! Vous pouvez maintenant fermer cette fen√™tre.";

      setOverlayMensaje(terminadoMsg);
      setTimeout(ocultarOverlay, 1800);

    } catch (err) {
      const errorMsg =
        idiomaActual === "es"
          ? "Error al terminar la encuesta, intentelo m√°s tarde."
          : idiomaActual === "en"
          ? "Error finishing the survey, please try again later."
          : "Erreur lors de la finalisation du sondage, veuillez r√©essayer plus tard.";

      setOverlayMensaje(errorMsg);
      setTimeout(ocultarOverlay, 2500);
    }

  });
});

function mostrarErrorCampo(campo, lang, invalido = false) {
  const mensajes = {
    es: invalido
      ? "Por favor, ingrese un n√∫mero telef√≥nico v√°lido."
      : "Por favor, complete este campo.",
    en: invalido
      ? "Please, enter a valid phone number."
      : "Please, complete this field.",
    fr: invalido
      ? "Veuillez, entrer un num√©ro de t√©l√©phone valide"
      : "Veuillez, compl√©ter ce champ."
  };

  const error = document.getElementById(`error-${campo}`);
  if (error) {
    error.textContent = mensajes[lang];
    error.style.display = "block";
  }
}

// Quitar error autom√°ticamente al escribir
["nombre", "telefono", "lugar", "fecha", "tour"].forEach(id => {
  const campo = document.getElementById(id);
  if (!campo) return;

  campo.addEventListener("input", () => {

    // üö´ NO borrar error del tel√©fono aqu√≠
    if (id === "telefono") return;

    campo.classList.remove("input-error");
    const err = document.getElementById("error-" + id);
    if (err) err.style.display = "none";
  });
});

// Quitar error autom√°ticamente al seleccionar botones
["conductor", "transporte", "alimentos"].forEach(id => {
  const group = document.querySelector(`.btn-group[data-field="${id}"]`);

  group.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      group.classList.remove("group-error");

      const err = document.getElementById("error-" + id);
      if (err) err.style.display = "none";
    });
  });
});

function mostrarOverlay(msg = "Cargando...") {
  
  const ov = document.getElementById("overlay");
  ov.style.display = "flex";
  setOverlayMensaje(msg);
}

function ocultarOverlay() {

  document.getElementById("overlay").style.display = "none";
}

function setOverlayMensaje(msg) {

  const el = document.getElementById("overlay-msg");
  el.textContent = msg;

  // reset visual (por si algo qued√≥ sucio antes)
  el.style.color = "";
  el.style.fontWeight = "";
}

/* ============================================================
   FUNCI√ìN PARA CAMBIAR IDIOMA ‚Äî REQUERIDA PARA QUE NO EXPLOTE
============================================================ */
function cambiarIdioma(lang) {

  // Declarar setText al inicio
  const setText = (id, text) => {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
  };

  // Validar traducciones
  if (typeof traducciones === 'undefined') {
    console.error('traducciones no est√° definida');
    return;
  }
  const t = traducciones[lang];
  if (!t) return;

  // ===== SECCI√ìN ‚ÄúOBTENGA M√ÅS INFORMACI√ìN‚Äù =====
  setText(
    "titulo-mas-info",
    lang === "es"
      ? "Obtenga m√°s informaci√≥n"
      : lang === "en"
      ? "Get more information"
      : "Obtenez plus d'informations"
  );

  // Traducci√≥n de los enlaces
  const txtOficial = document.getElementById("txtOficial");
  if (txtOficial)
    txtOficial.querySelector("a").textContent =
      lang === "es"
        ? "Kichan Bajlum Oficial"
        : lang === "en"
        ? "Official Kichan Bajlum"
        : "Kichan Bajlum Officiel";

  const txtFacebook = document.getElementById("txtFacebook");
  if (txtFacebook)
    txtFacebook.querySelector("a").textContent = "Kichan Bajlum Facebook";

  const txtTripadvisor = document.getElementById("txtTripadvisor");
  if (txtTripadvisor)
    txtTripadvisor.querySelector("a").textContent = "Kichan Bajlum Tripadvisor";

  // Traducci√≥n de botones de grupo
  // ===== BOTONES DE OPCIONES (selecci√≥n real) =====
document.querySelectorAll(".btn-group").forEach(group => {
  const botones = group.querySelectorAll("button");
  const textos = opciones[lang];

  botones.forEach((btn, i) => {
    btn.textContent = textos[i];
  });
});

  // T√çTULOS
  setText("titulo-encuesta", t.header);
  setText("title-window", t.titulo);

  // LABELS
  setText("label-nombre",
    lang === "es" ? "Nombre:" :
    lang === "en" ? "Name:" : "Nom:"
  );

  setText("label-telefono",
    lang === "es" ? "N√∫mero telef√≥nico:" :
    lang === "en" ? "Phone number:" : "Num√©ro de t√©l√©phone:"
  );

  setText("label-correo",
    lang === "es" ? "Correo electr√≥nico:" :
    lang === "en" ? "Email:" : "E-mail:"
  );

  setText("label-lugar",
    lang === "es" ? "Lugar:" :
    lang === "en" ? "Place:" : "Lieu:"
  );

  setText("label-fecha",
    lang === "es" ? "Fecha:" :
    lang === "en" ? "Date:" : "Date:"
  );

  setText("label-tour", "Tour:");
  setText("label-conductor",
    lang === "es" ? "Conductor:" :
    lang === "en" ? "Driver:" : "Conducteur:"
  );

  setText("label-transporte",
    lang === "es" ? "Transporte:" :
    lang === "en" ? "Transport:" : "Transport:"
  );

  setText("label-alimentos",
    lang === "es" ? "Alimentos:" :
    lang === "en" ? "Food:" : "Nourriture:"
  );

  setText("label-comentarios",
    lang === "es" ? "Comentarios (opcional):" :
    lang === "en" ? "Comments (optional):" :
                    "Commentaires (facultatif):"
  );

  setText("guardarEncuesta",
    lang === "es" ? "Terminar Encuesta" :
    lang === "en" ? "Finish Survey" :
                    "Terminer l'enqu√™te"
  );
}

const mensajesEnvio = {
  es: {
    enviando: "Terminando la Encuesta, por favor no cierre ni refresque esta p√°gina‚Ä¶",
    ok: "Encuesta enviada correctamente",
    error: "Error al enviar la encuesta"
  },
  en: {
    enviando: "Finishing the survey, please do not close or refresh this page‚Ä¶",
    ok: "Survey sent successfully",
    error: "Error sending the survey"
  },
  fr: {
    enviando: "Apr√®s avoir r√©pondu au sondage, veuillez ne pas fermer ni actualiser cette page‚Ä¶",
    ok: "Sondage envoy√© avec succ√®s",
    error: "Erreur lors de l‚Äôenvoi du sondage"
  }
};

// Eliminado: la traducci√≥n de botones ahora est√° dentro de cambiarIdioma(lang)

// --- CARGAR AL ABRIR LA P√ÅGINA ---
setTimeout(fijarPrefijoActual, 0);

// === BOT√ìN: VOLVER A IDIOMA ===
document.getElementById("volver-idioma").addEventListener("click", () => {

  // üî• reset duro del tel√©fono
  telefonoFueEditado = false;
  ocultarErrorTelefono();

  inputTelefono.value = "";
  paisInicialPorIdioma(idiomaActual);
  fijarPrefijoActual();

  document.getElementById("pantalla-idioma").style.display = "flex";
  document.getElementById("main-encuesta").style.display = "none";

  limpiarFormulario();
});

/* ---------- inicializaci√≥n √∫nica y fija de flatpickr ---------- */
(function() {
  // Aseg√∫rate de ejecutar esto cuando el DOM est√© listo

    // Funci√≥n que (re)inicia flatpickr en #fecha con la localizaci√≥n pasada
    function crearFlatpickr(local) {
      // Si ya existe, destr√∫yelo para evitar duplicados
      if (window.fpFecha && typeof window.fpFecha.destroy === "function") {
        try { window.fpFecha.destroy(); } catch(e){ /* no importa */ }
      }

      // Inicializa y guarda la instancia globalmente
      window.fpFecha = flatpickr("#fecha", {
        disableMobile: true,
        dateFormat: "d/m/Y",      // formato interno
        altInput: true,           // campo alterno para mostrar bonito
        altFormat: "d/m/Y",       // formato visible
        defaultDate: new Date(),  // pone hoy como valor inicial (as√≠ aparece el a√±o)
        allowInput: false,      // no permitir escribir manualmente
        locale: local || "es",    // 'es','en' o 'fr'
        onReady: function(selectedDates, dateStr, instance) {
          // Si el campo aparece vac√≠o por CSS u overlay, forzamos que muestre el altInput value
          try {
            instance.input.value = instance.altInput ? instance.altInput.value : dateStr;
          } catch(e){ /* noop */ }
          console.log("flatpickr listo:", local);
        },
        onOpen: function() {
          // √∫til para pruebas: abre y asegura que el encabezado del calendario tenga texto
          setTimeout(()=> {
            const yearEl = document.querySelector(".flatpickr-current-month .numInputWrapper input.cur-year");
            if (yearEl && yearEl.value === "") {
              // forzamos el a√±o a mostrar si por alg√∫n motivo est√° vac√≠o
              yearEl.value = (new Date()).getFullYear();
            }
          }, 50);
        }
      });
    }

    // Cuando el usuario elige idioma (ya tienes botones con data-lang)
    document.querySelectorAll("#pantalla-idioma button").forEach(b => {
      b.addEventListener("click", () => {
        const lang = b.dataset.lang || "es";

        // traducir textos ya lo manejas con cambiarIdioma(), solo reiniciamos flatpickr
        // flatpickr admite strings 'es'/'en'/'fr' si las localizaciones fueron cargadas
        crearFlatpickr(lang);
      });
    });

})();

const fechaInput = document.getElementById("fecha");

  // ===== ACTIVAR SELECCI√ìN DE BOTONES (VERDE + TEXTO BLANCO) =====
document.querySelectorAll(".btn-group").forEach(group => {
  const botones = group.querySelectorAll("button");

  botones.forEach(btn => {
    btn.addEventListener("click", () => {

      // quitar selecci√≥n previa del grupo
      botones.forEach(b => b.classList.remove("selected"));

      // marcar el actual
      btn.classList.add("selected");

    });
  });
});

</script>

<!-- CONFIRMADOR PERSONALIZADO -->
<div id="confirmador" class="confirm-overlay" style="display:none;">
  <div class="confirm-box">
    <h3>¬øDesea continuar?</h3>
    <div class="confirm-btns">
      <button id="btnConfirmar" class="btn-verde">Continuar</button>
      <button id="btnCancelar" class="btn-rojo">Cancelar</button>
    </div>
  </div>
</div>

</body>
</html>