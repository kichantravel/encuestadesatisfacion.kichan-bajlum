<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title id="title-window">Encuesta de Satisfacci√≥n</title>
<link rel="icon" type="image/jpeg" href="a.jpg">

<style>
  
  body {
    font-family: Arial, sans-serif;
    background-color: #d4f0d4;
    margin: 0;
    padding: 0;
    font-size: 16px;
  }

  /* Overlay */
 #overlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background-color: rgba(212,240,212,0.9);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:9998;
    font-size:24px;
    color:#4CAF50;
  }
  .overlay-content {
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
  }
  .icono svg { width:48px; height:48px; }
  .barra {
    width:100px; height:6px;
    background:#c0f0c2;
    border-radius:3px;
    margin:10px 0;
    overflow:hidden;
  }
  .progreso {
    width:50%;
    height:100%;
    background:#2e7d32;
    animation:carga 1s infinite alternate;
  }
  @keyframes carga { from{width:10%} to{width:90%} }

  #overlay-msg {
  color: #2e7d32;   /* verde fijo y consistente */
  font-weight: bold;
  }

  /* Pantalla de idioma */
  #pantalla-idioma {
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background-color: #d4f0d4;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }
  #pantalla-idioma h2 { font-size:28px; margin-bottom:30px; text-align:center; }
  #pantalla-idioma button {
    padding:15px 25px;
    margin:10px;
    font-size:18px;
    border:none;
    border-radius:5px;
    cursor:pointer;
    background-color:#4CAF50;
    color:white;
    transition:0.2s;
  }
  #pantalla-idioma button:hover { background-color:#45a049; }

  header {
    background-color:#4CAF50;
    height:100px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    padding:0 15px;
    position:relative;
  }
  header .header-content { display:flex; align-items:center; gap:10px; }
  header img { height:80px; width:auto; }
  header h1 { color:white; font-size:30px; margin:0; text-align:center; }
  #volver-idioma { cursor:pointer; fill:white; width:40px; height:40px; }

  main {
    max-width:600px;
    margin:20px auto;
    padding:1em;
    background:white;
    border-radius:10px;
    box-shadow:0 0 10px rgba(0,0,0,0.1);
    display:none;
  }

  label { display:block; margin-top:10px; font-weight:bold; }
  input, textarea, select {
    width:100%;
    padding:8px;
    margin-top:5px;
    border-radius:5px;
    border:1px solid #ccc;
    box-sizing:border-box;
    resize:none;
    overflow:visible;
  }
  .autoexpand { overflow:hidden; }

  .btn-group {
    display:flex;
    justify-content:space-between;
    margin-top:5px;
  }
  .btn-group button {
    flex:1;
    margin-right:5px;
    padding:10px;
    border-radius:5px;
    border:1px solid #4CAF50;
    background:white;
    color:#4CAF50;
    font-weight:bold;
    cursor:pointer;
    transition:0.2s;
  }
  .btn-group button:last-child { margin-right:0; }
  .btn-group button.selected { background:#4CAF50; color:white; }

  button#guardarEncuesta {
    background-color:#4CAF50;
    color:white;
    border:none;
    padding:10px 20px;
    margin-top:15px;
    cursor:pointer;
    border-radius:5px;
    font-size:16px;
    width:100%;
  }
  button#guardarEncuesta:hover { background-color:#45a049; }

  #mas-info a { color:#007bff; text-decoration:none; font-weight:bold; }

.error-msg {
  color: red;
  font-size: 14px;
  margin-top: 5px;
  display: none; /* Oculto por defecto */
}

.field-error {
  border: 2px solid red !important;
}

.confirm-overlay {
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
}

.confirm-box {
  background:white;
  padding:25px;
  border-radius:10px;
  text-align:center;
  width:80%;
  max-width:350px;
}

.btn-verde {
  background:#4CAF50;
  color:white;
  padding:10px 20px;
  border:none;
  margin:10px;
  cursor:pointer;
  border-radius:5px;
}

.btn-rojo {
  background:#e53935;
  color:white;
  padding:10px 20px;
  border:none;
  margin:10px;
  cursor:pointer;
  border-radius:5px;
}

.group-error {
  border: 2px solid #ff4d4d !important;
  border-radius: 8px;
  padding: 5px;
  animation: glowError 0.6s ease-in-out infinite alternate;
}

@keyframes glowError {
  from { box-shadow: 0 0 5px rgba(255, 77, 77, 0.5); }
  to   { box-shadow: 0 0 14px rgba(255, 0, 0, 0.9); }
}

.input-error {
  border: 2px solid #ff4d4d !important;
  border-radius: 6px;
  animation: glowInput 0.6s ease-in-out infinite alternate;
}

@keyframes glowInput {
  from { box-shadow: 0 0 5px rgba(255, 77, 77, 0.4); }
  to   { box-shadow: 0 0 12px rgba(255, 0, 0, 0.9); }
}

#mensaje-estado {
  width: 100%;
  text-align: center;
  padding: 12px;
  font-size: 18px;
  font-weight: bold;
  border-radius: 6px;
  display: none;
  margin-bottom: 15px;
}

.msg-ok {
  background: #4CAF50;
  color: white;
  display: block !important;
}

.msg-error {
  background: #e53935;
  color: white;
  display: block !important;
}

/* ===== PDF: texto largo SIN perder letras ===== */
input,
textarea {
  white-space: normal !important;
  overflow-wrap: anywhere !important;
  word-break: break-word !important;
  overflow: visible !important;
}

.pdf-campo {
  display: block;
  width: 100%;
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: anywhere;
  font-family: inherit;
  font-size: 14px;
  line-height: 1.6;          /* üëà m√°s aire entre l√≠neas */
  padding: 6px 8px 14px;     /* üëà espacio extra abajo */
  margin-bottom: 12px;       /* üëà colch√≥n antes de posible salto */
  border-bottom: 1px solid #999;
  min-height: 20px;
}

.error-campo {
  background: #fdecea;
  color: #c62828;
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 14px;
  margin-bottom: 8px;
  text-align: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

.error-campo.hidden {
  display: none;
}

/* ===== intl-tel-input: alineaci√≥n PERFECTA ===== */
.iti input {
  font: inherit;
  padding: 8px;
  line-height: normal;
  box-sizing: border-box;
}

.iti {
  width: 100%;
}

.iti__selected-flag {
  height: 100%;
  display: flex;
  align-items: center;
}

.campo-telefono {
  margin-bottom: 16px; /* usa el mismo valor que los otros campos */
}

.campo-telefono label {
  display: block;
  margin-bottom: 6px;
}

/* Igualar espacio entre label y campo de tel√©fono */
#label-telefono {
  display: block;
  margin-bottom: 6px;
}

/* Evitar que intl-tel-input meta espacio extra */
.iti {
  margin-top: 0;
}

</style>
</head>

<body>

<!-- Overlay -->
<div id="overlay">
  <div class="overlay-content">
    <div class="icono">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48">
        <path fill="#2e7d32" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5 14.5 7.62 14.5 9 13.38 11.5 12 11.5z"/>
      </svg>
    </div>
    <div class="barra">
      <div class="progreso"></div>
    </div>
    <p id="overlay-msg">Cargando...</p>
  </div>
</div>

<!-- Pantalla de idioma -->
<div id="pantalla-idioma">
  <h2 id="pantalla-idioma-titulo">Seleccione su idioma / Select your language / S√©lectionnez votre langue</h2>
  <button data-lang="es">Espa√±ol</button>
  <button data-lang="en">English</button>
  <button data-lang="fr">Fran√ßais</button>
</div>

<header>
  <div class="header-content">
    <svg id="volver-idioma" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M15 6l-6 6 6 6" stroke-width="2" stroke="white" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <img src="a.jpg" alt="Logo">
    <h1 id="titulo-encuesta">Encuesta de Satisfacci√≥n</h1>
  </div>
</header>

<main id="main-encuesta">

  <div id="mensaje-estado"></div>

  <form id="encuestaForm" autocomplete="off">

    <label id="label-nombre" for="nombre">Nombre:</label>
    <textarea id="nombre" name="nombre" class="autoexpand" rows="1" autocomplete="off"></textarea>
    <div class="error-msg" id="error-nombre"></div>

    <label for="telefono" id="label-telefono">N√∫mero telef√≥nico</label>

<input
  id="telefono"
  type="tel"
  inputmode="tel"
  autocomplete="off"
/>

<div class="error-msg" id="error-telefono"></div>

<label id="label-correo electr√≥nico" for="correoelectr√≥nico">Correo electr√≥nico:</label>
<input type="email" id="correoelectr√≥nico" name="correoelectr√≥nico" class="autoexpand" rows="1" autocomplete="off">

<div class="error-msg" id="error-correo"></div>

    <label id="label-lugar" for="lugar">Lugar:</label>
    <textarea id="lugar" name="lugar" class="autoexpand" rows="1" autocomplete="off"></textarea>
    <div class="error-msg" id="error-lugar"></div>

    <label id="label-fecha" for="fecha">Fecha:</label>
    <input type="text" id="fecha" name="fecha">
    <div class="error-msg" id="error-fecha"></div>

    <label id="label-tour" for="tour">Tour:</label>
    <textarea id="tour" name="tour" class="autoexpand" rows="1" autocomplete="off" ></textarea>
    <div class="error-msg" id="error-tour"></div>

    <label id="label-conductor">Conductor:</label>
    <div class="btn-group" data-field="conductor">
      <button type="button">Excelente</button>
      <button type="button">Bueno</button>
      <button type="button">Regular</button>
      <button type="button">Malo</button>
    </div>

    <label id="label-transporte">Transporte:</label>
    <div class="btn-group" data-field="transporte">
      <button type="button">Excelente</button>
      <button type="button">Bueno</button>
      <button type="button">Regular</button>
      <button type="button">Malo</button>
    </div>

    <label id="label-alimentos">Alimentos:</label>
    <div class="btn-group" data-field="alimentos">
      <button type="button">Excelente</button>
      <button type="button">Bueno</button>
      <button type="button">Regular</button>
      <button type="button">Malo</button>
    </div>

    <label id="label-comentarios" for="comentarios">Comentarios (opcional):</label>
    <textarea id="comentarios" name="comentarios" class="autoexpand" rows="4" autocomplete="off"></textarea>

    <button type="button" id="guardarEncuesta">Terminar Encuesta</button>
  </form>

  <hr style="margin:30px 0;">
  <section id="mas-info" style="text-align:center; padding:20px; background-color:#e8f5e9; border-radius:10px;">
    <h2 id="titulo-mas-info">Obtenga m√°s informaci√≥n</h2>
    <div style="display:flex; justify-content:space-around; flex-wrap:wrap; margin-top:20px; gap:20px;">
      <div>
        <img src="QR1.png" alt="QR Kichan Bajlum Oficial" width="200" height="200">
        <p id="txtOficial"><a href="https://www.kichantravel.com/" target="_blank">Kichan Bajlum Oficial</a></p>
      </div>
      <div>
        <img src="QR2.png" alt="QR Kichan Bajlum Facebook" width="200" height="200">
        <p id="txtFacebook"><a href="https://www.facebook.com/KichanBajlumOficial/" target="_blank">Kichan Bajlum Facebook</a></p>
      </div>
      <div>
        <img src="QR3.png" alt="QR Kichan Bajlum Tripadvisor" width="200" height="200">
        <p id="txtTripadvisor"><a href="https://www.tripadvisor.com.mx/Attraction_Review-g249851-d10294242-Reviews-Kichan_Bajlum_Tour_Operator-Palenque_Southern_Mexico.html" target="_blank">Kichan Bajlum Tripadvisor</a></p>
      </div>
    </div>
  </section>
</main>

<link rel="stylesheet" href="https://unpkg.com/flatpickr/dist/flatpickr.min.css">

<script src="https://unpkg.com/flatpickr/dist/flatpickr.min.js"></script>

<!-- Idiomas -->
<script src="https://unpkg.com/flatpickr/dist/l10n/es.js"></script>
<script src="https://unpkg.com/flatpickr/dist/l10n/fr.js"></script>

<!-- Librer√≠a html2pdf (OBLIGATORIA) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js"></script>

<script>

  let iti = null;
  let idiomaActual = "es";
  let inputTelefono = null;
  let ultimoTelefonoValido = "";

  document.addEventListener("DOMContentLoaded", () => {
  localStorage.clear();        // üî• mata todo
  resetearFormularioCompleto(); // deja el formulario virgen
});

document.addEventListener("DOMContentLoaded", () => {
  inputTelefono = document.getElementById("telefono");

  iti = window.intlTelInput(inputTelefono, {
    initialCountry: "mx",
    nationalMode: false,
    separateDialCode: false,
    autoPlaceholder: "off",
    formatOnDisplay: false,
    preferredCountries: ["mx", "us", "fr"],
    utilsScript:
      "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js",
  });

  // üî• aplicar l√≠mite inicial por pa√≠s
setTimeout(aplicarLimitePorPais, 0);

// üî• cuando cambia la bandera / pa√≠s
inputTelefono.addEventListener("countrychange", aplicarLimitePorPais);

inputTelefono.addEventListener("blur", validarTelefonoEnVivo);

// al salir del campo
inputTelefono.addEventListener("input", () => {
  let valor = inputTelefono.value;

  // siempre empieza con +
  if (!valor.startsWith("+")) {
    valor = "+" + valor.replace(/\+/g, "");
  }

  // solo n√∫meros despu√©s del +
  valor = "+" + valor.slice(1).replace(/\D/g, "");

  const data = iti.getSelectedCountryData();
  if (!data) return;

  const maxDigitos = Number(inputTelefono.dataset.maxDigitos);

if (!maxDigitos) {
  inputTelefono.value = valor;
  return;
}

  // d√≠gitos nacionales (sin prefijo)
  const digitosNacionales = valor
  .replace("+" + data.dialCode, "")
  .replace(/\D/g, "");

  // üö´ si ya lleg√≥ al l√≠mite, NO deja escribir m√°s
  if (digitosNacionales.length > maxDigitos) {
    valor =
      "+" +
      data.dialCode +
      digitosNacionales.slice(0, maxDigitos);
  }

  inputTelefono.value = valor;
});
});

// ------------------- FIN BLOQUE TELEFONO -------------------

function fijarPrefijoActual() {
  if (!iti) return;
  if (!inputTelefono.value) inputTelefono.value = "+";
}

const traduccionesPaises = {
  es: { Mexico: "M√©xico", France: "Francia" },
  en: { Mexico: "Mexico", France: "France" },
  fr: { Mexico: "Mexique", France: "France" }
};

function paisInicialPorIdioma(idioma) {
  if (!iti) return;

  let countryCode;
  switch (idioma) {
    case "es": countryCode = "mx"; break;
    case "en": countryCode = "us"; break;
    case "fr": countryCode = "fr"; break;
  }

  iti.setCountry(countryCode);

  const data = iti.getSelectedCountryData();
  inputTelefono.value = "+" + (data?.dialCode || "52");

  aplicarLimitePorPais(); // üî• PASO 2 ‚Äì parte B
  
  }

  /*=============================================================
   TRADUCCIONES
============================================================ */
const traducciones = {
  es: {
    alertaTitulo: "¬øDesea continuar?",
    continuar: "Continuar",
    cancelar: "Cancelar",
    msgCampo: "Por favor complete este campo.",
    titulo: "Encuesta de Satisfaci√≥n",
    header: "Encuesta de Satisfacci√≥n"
  },
  en: {
    alertaTitulo: "Do you want to continue?",
    continuar: "Continue",
    cancelar: "Cancel",
    msgCampo: "Please fill out this field.",
    titulo: "Encuesta de Satisfaci√≥n",
    header: "Satisfaction Survey"
  },
  fr: {
    alertaTitulo: "Voulez-vous continuer ?",
    continuar: "Continuer",
    cancelar: "Annuler",
    msgCampo: "Veuillez remplir ce champ.",
    titulo: "Encuesta de Satisfaci√≥n",
    header: "Enqu√™te de Satisfaction"
  }
};

const mensajesTelefono = {
  es: "Ingrese un n√∫mero telef√≥nico v√°lido",
  en: "Enter a valid phone number",
  fr: "Entrez un num√©ro de t√©l√©phone valide"
};

document.title = "Encuesta de Satisfacci√≥n"; // siempre en espa√±ol en la selecci√≥n

const idiomaConfig = {
  es: {
    country: "mx",
    lang: "es",
    error: "N√∫mero de tel√©fono inv√°lido",
    label: "N√∫mero telef√≥nico"
  },
  en: {
    country: "us",
    lang: "en",
    error: "Invalid phone number",
    label: "Phone number"
  },
  fr: {
    country: "fr",
    lang: "fr",
    error: "Num√©ro de t√©l√©phone invalide",
    label: "Num√©ro de t√©l√©phone"
  }
};

const telefonoHintTexto = {
  es: "Seleccione un pa√≠s",
  en: "Select a country",
  fr: "S√©lectionnez un pays"
};

function actualizarTelefonoHint(idioma) {
  const hint = document.getElementById("telefono-hint");
  if (hint) hint.textContent = telefonoHintTexto[idioma] || telefonoHintTexto.es;
}

    document.title = "Encuesta de Satisfacci√≥n";
document.getElementById("title-window").textContent = "Encuesta de Satisfacci√≥n";

    window.fpFecha = null;

function add(id, event, handler) {
  const el = document.getElementById(id);
  if (!el) {
    console.warn("Elemento no encontrado:", id);
    return;
  }
  el.addEventListener(event, handler);
}

  let idioma = "es"; // evita el ReferenceError

// === VALIDAR CORREO ===
function validarCorreo() {
  const correo = document.getElementById("correo");
  const error = document.getElementById("error-correo");

  const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  if (!regex.test(correo.value.trim())) {
    error.textContent = "Correo electr√≥nico inv√°lido";
    error.style.display = "block";
    correo.classList.add("input-error");
    return false;
  }

  error.style.display = "none";
  correo.classList.remove("input-error");
  return true;
}

// === OBTENER TEL√âFONO FINAL UNIDO ===
function obtenerTelefonoFinal() {
  return iti.getNumber(); // üëâ +5219161172035
}

  function mensajeOK() {
  const box = document.getElementById("mensaje-estado");
  box.className = "msg-ok";
  box.textContent = "Encuesta enviada correctamente";
  box.style.display = "block";
  setTimeout(() => box.style.display = "none", 3000);
}

function mensajeERROR() {
  const box = document.getElementById("mensaje-estado");
  box.className = "msg-error";
  box.textContent = "Error al enviar encuesta";
  box.style.display = "block";
  setTimeout(() => box.style.display = "none", 3000);
}

/* ============================================================
   BOT√ìN VOLVER A IDIOMA ‚Äî AHORA FUNCIONA
============================================================ */
document.getElementById("volver-idioma").addEventListener("click", () => {
  document.getElementById("pantalla-idioma").style.display = "flex";
  document.getElementById("main-encuesta").style.display = "none";
});

/* ============================================================
   AUTOEXPAND
============================================================ */
document.querySelectorAll(".autoexpand").forEach(area => {
  area.addEventListener("input", () => {
    area.style.height = "auto";
    area.style.height = area.scrollHeight + "px";
  });
});

/* ============================================================
   BOTONES DE GRUPO
============================================================ */
document.querySelectorAll(".btn-group").forEach(group => {
  group.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      group.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
    });
  });
});

document.querySelectorAll("#pantalla-idioma button").forEach(boton => {
  boton.addEventListener("click", () => {

    idiomaActual = boton.dataset.lang;
    paisInicialPorIdioma(idiomaActual);

    document.getElementById("pantalla-idioma").style.display = "none";
    document.getElementById("main-encuesta").style.display = "block";
    document.getElementById("overlay").style.display = "none";

    document.title = "Encuesta de Satisfacci√≥n";

    cambiarIdioma(idiomaActual);

    // üëá AQUI AGREGA ESTO
    loadFormState(); // solo si ya eligi√≥ idioma

  });
});

    /* ============================================================
   LIMPIAR FORMULARIO AL CAMBIAR DE IDIOMA
============================================================ */
function limpiarCamposEncuesta() {

  const inputs = document.querySelectorAll(
    "input[type='text'], input[type='number'], textarea"
  );
  inputs.forEach(i => i.value = "");

  const radios = document.querySelectorAll("input[type='radio']");
  radios.forEach(r => r.checked = false);

  const selects = document.querySelectorAll("select");
  selects.forEach(s => s.selectedIndex = 0);

  // La fecha NO se borra porque la auto-generas con flatpickr
}

setTimeout(() => {
    if (window.fpFecha) window.fpFecha.destroy();

    window.fpFecha = flatpickr("#fecha", {
        dateFormat: "d/m/Y",
        locale: flatpickr.l10ns[idiomaActual]
    });
}, 200);

function limpiarFormulario() {
  // Campos de texto y textarea
  ["nombre", "telefono", "correoelectr√≥nico", "lugar", "fecha", "tour", "comentarios"].forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      campo.value = "";
      campo.style.height = "auto"; // reset del autoexpand
    }
  });

  // Botones seleccionados
  document.querySelectorAll(".btn-group button.selected").forEach(btn => {
    btn.classList.remove("selected");
  });

  // Borrar mensajes de error
  document.querySelectorAll(".error-msg").forEach(err => {
    err.style.display = "none";
  });

  // Quitar efectos de error
  document.querySelectorAll(".input-error").forEach(el => {
    el.classList.remove("input-error");
  });

  document.querySelectorAll(".group-error").forEach(el => {
    el.classList.remove("group-error");
  });
}

/* ============================================================
   VALIDACI√ìN
============================================================ */
function validarCampos() {
  const t = traducciones[idiomaActual];
  let ok = true;

  // CAMPOS DE TEXTO
  const camposTexto = ["nombre", "telefono", "correoelectr√≥nico", "lugar", "fecha", "tour"];

  camposTexto.forEach(id => {
    let campo = document.getElementById(id);
    let error = document.getElementById("error-" + id);

if (!campo.value.trim()) {
  ok = false;
  campo.classList.add("input-error");

  if (!error) {
    error = document.createElement("div");
    error.id = "error-" + id;
    error.className = "error-msg";
    campo.insertAdjacentElement("afterend", error);
  }

  error.textContent = t.msgCampo;
  error.style.display = "block";
} else {
  campo.classList.remove("input-error");
  if (error) error.style.display = "none";
}
  });

  // CAMPOS DE OPCIONES (BOTONES)
  const grupos = ["conductor", "transporte", "alimentos"];

  grupos.forEach(id => {
    const group = document.querySelector(`.btn-group[data-field="${id}"]`);
    const seleccionado = group.querySelector(".selected");

    const msg = (idiomaActual === "es")
      ? "Por favor, seleccione una opci√≥n"
      : (idiomaActual === "en")
        ? "Please select an option"
        : "Veuillez s√©lectionner une option";

    if (!seleccionado) {
      ok = false;

      group.classList.add("group-error");

      let err = document.getElementById("error-" + id);
      if (!err) {
        err = document.createElement("div");
        err.id = "error-" + id;
        err.className = "error-msg";
        group.insertAdjacentElement("afterend", err);
      }

      err.textContent = msg;
      err.style.display = "block";

    } else {
      group.classList.remove("group-error");

      const err = document.getElementById("error-" + id);
      if (err) err.style.display = "none";
    }
  });

  return ok;
}

function telefonoEsValido() {
  if (!iti) return false;
  return iti.isValidNumber();
}

/* ============================================================
   ALERTA PERSONALIZADA ‚Äî FUNCIONAL Y TRADUCIBLE
============================================================ */
function mostrarAlerta(callback) {
  const t = traducciones[idiomaActual];

  document.querySelectorAll(".confirm-overlay").forEach(e => e.remove());

  const overlay = document.createElement("div");
  overlay.className = "confirm-overlay";

  const box = document.createElement("div");
  box.className = "confirm-box";
  box.innerHTML = `
    <h3>${t.alertaTitulo}</h3>
    <button id="btnConfirmar" class="btn-verde">${t.continuar}</button>
    <button id="btnCancelar" class="btn-rojo">${t.cancelar}</button>
  `;

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  document.getElementById("btnConfirmar").onclick = () => {
    overlay.remove();
    callback(true);
  };
  document.getElementById("btnCancelar").onclick = () => {
    overlay.remove();
    callback(false);
  };
}

function prepararCamposParaPDF() {
  const campos = document.querySelectorAll(
    '#encuestaForm input, #encuestaForm textarea, #encuestaForm select'
  );

  campos.forEach(campo => {
    let valor = '';

    if (campo.tagName === 'SELECT') {
      valor = campo.options[campo.selectedIndex]?.text || '';
    } else {
      valor = campo.value || '';
    }

    const div = document.createElement('div');
    div.className = 'pdf-campo';
    div.textContent = valor || ' ';
    div.dataset.pdfReemplazo = 'true';

    campo.style.display = 'none';
    campo.parentNode.insertBefore(div, campo.nextSibling);
  });
}

/* ============================================================
   ENV√çO REAL
============================================================ */
async function generarYEnviarPDF() {
  mostrarOverlay(mensajesEnvio[idiomaActual].enviando);

    prepararCamposParaPDF();

  try {
const pdf = await html2pdf()
  .from(document.getElementById("encuestaForm"))
  .set({
    margin: [10, 10, 10, 10],
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: {
    scale: 2,
    useCORS: true,
    scrollY: 0,
    windowWidth: document.body.scrollWidth,
    letterRendering: true   // üëà mejora cortes de texto
    },
    jsPDF: {
      unit: "mm",
      format: "a4",
      orientation: "portrait"
    }
  })
  .outputPdf("datauristring");

  restaurarCamposDespuesPDF(); // üî• Y ESTA TAMBI√âN

    const base64 = pdf.split(",")[1];

    await fetch("https://script.google.com/macros/s/AKfycbzTFXLQI5KzzUBNWJnNi8HCz5m7szjdQTY7ReHVe-E0r7EnfAY5PJlC3nt6PtrhGJ_D_Q/exec", {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        archivo: base64,
        nombre: "Encuesta_" + Date.now() + ".pdf"
      })
    });

    setOverlayMensaje(mensajesEnvio[idiomaActual].ok);
    setTimeout(ocultarOverlay, 1500);

  } catch (e) {
    console.error(e);
    setOverlayMensaje(mensajesEnvio[idiomaActual].error);
    setTimeout(ocultarOverlay, 2000);
  }
}

function restaurarCamposDespuesPDF() {
  document.querySelectorAll('[data-pdf-reemplazo]').forEach(div => {
    const campo = div.previousSibling;
    if (campo) campo.style.display = '';
    div.remove();
  });
}

/* =====================================
   VALIDACI√ìN CON TU MISMA ALERTA
===================================== */
function validarTelefonoEnVivo() {
  const error = document.getElementById("error-telefono");

  if (!inputTelefono.value || inputTelefono.value === "+") {
    error.textContent = mensajesTelefono[idiomaActual];
    error.style.display = "block";
    inputTelefono.classList.add("input-error");
    return false;
  }

  if (!iti || !iti.isValidNumber()) {
    error.textContent = mensajesTelefono[idiomaActual];
    error.style.display = "block";
    inputTelefono.classList.add("input-error");
    return false;
  }

  error.style.display = "none";
  inputTelefono.classList.remove("input-error");
  return true;
}

function aplicarLimitePorPais() {
  if (!iti || !window.intlTelInputUtils) return;

  const data = iti.getSelectedCountryData();
  if (!data || !data.iso2) return;

  // ejemplo REAL del pa√≠s (nacional)
  const ejemplo = window.intlTelInputUtils.getExampleNumber(
    data.iso2,
    false,
    window.intlTelInputUtils.numberFormat.NATIONAL
  );

  if (!ejemplo) return;

  // cuenta SOLO los d√≠gitos nacionales
  const maxDigitos = ejemplo.replace(/\D/g, "").length;

  inputTelefono.dataset.maxDigitos = maxDigitos;
}

/* ============================================================
   BOT√ìN PRINCIPAL ‚Äî AHORA S√ç FUNCIONA
============================================================ */
document.getElementById("guardarEncuesta").addEventListener("click", () => {

  // primero valida campos normales
  if (!validarCampos()) return;

// üî• BLOQUEO DURO POR TEL√âFONO
if (!validarTelefonoEnVivo()) {
  inputTelefono.focus();
  return;
}

if (!iti || !iti.isValidNumber()) {
  mostrarErrorTelefono(
    idiomaActual === "es"
      ? "Ingrese un n√∫mero telef√≥nico v√°lido"
      : idiomaActual === "en"
      ? "Enter a valid phone number"
      : "Entrez un num√©ro de t√©l√©phone valide"
  );
  return; // üî• ESTO evita que contin√∫e
}

  mostrarAlerta(async ok => {
    if (!ok) return;

const mensajesEnvio = {
  es: "Terminando la Encuesta, por favokr no cierre, ni refresque esta p√°gina‚Ä¶",
  en: "Finishing the survey, please do not close or refresh this page‚Ä¶",
  fr: "Apr√®s avoir r√©pondu au sondage, veuillez ne pas fermer ni actualiser cette page‚Ä¶"
};

    try {
      const pdf = await generarYEnviarPDF();
      const base64 = pdf.split(",")[1];

      await enviarADrive(base64);

      const terminadoMsg = idiomaActual === "es" ? 
                            "Encuesta terminada correctamente, puede cerrar esta ventana. ¬°Gracias por su tiempo! Ya puede cerrar esta ventana." :
                            idiomaActual === "en" ? 
                            "Survey completed successfully. Thank you for your time! You can now close this page." :
                            "Sondage termin√© avec succ√®s. Merci pour votre participation¬†! Vous pouvez maintenant fermer cette page.";

      setOverlayMensaje(terminadoMsg);
      setTimeout(() => ocultarOverlay(), 1800);

    } catch (err) {
  const errorMsg =
    idiomaActual === "es"
      ? "Error al terminar la encuesta, int√©ntelo m√°s tarde"
      : idiomaActual === "en"
      ? "Error finishing the survey, please try again later"
      : "Erreur lors de la finalisation du sondage, veuillez r√©essayer plus tard";

  setOverlayMensaje(errorMsg);
  setTimeout(() => ocultarOverlay(), 2500);
}

  });
});

function mostrarErrorCampo(campo, lang, invalido = false) {
  const mensajes = {
    es: invalido
      ? "Ingrese un n√∫mero telef√≥nico v√°lido"
      : "Este campo es obligatorio",
    en: invalido
      ? "Please enter a valid phone number"
      : "This field is required",
    fr: invalido
      ? "Veuillez entrer un num√©ro de t√©l√©phone valide"
      : "Ce champ est obligatoire"
  };

  const error = document.getElementById(`error-${campo}`);
  if (error) {
    error.textContent = mensajes[lang];
    error.style.display = "block";
  }
}

// Quitar error autom√°ticamente al escribir
["nombre", "telefono", "correoelectr√≥nico", "lugar", "fecha", "tour"].forEach(id => {
  const campo = document.getElementById(id);

  campo.addEventListener("input", () => {
    campo.classList.remove("input-error");
    const err = document.getElementById("error-" + id);
    if (err) err.style.display = "none";
  });
});

// Quitar error autom√°ticamente al seleccionar botones
["conductor", "transporte", "alimentos"].forEach(id => {
  const group = document.querySelector(`.btn-group[data-field="${id}"]`);

  group.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      group.classList.remove("group-error");

      const err = document.getElementById("error-" + id);
      if (err) err.style.display = "none";
    });
  });
});

function mostrarOverlay(msg = "Cargando...") {
  
  const ov = document.getElementById("overlay");
  ov.style.display = "flex";
  setOverlayMensaje(msg);
}

function ocultarOverlay() {

  document.getElementById("overlay").style.display = "none";
}

function setOverlayMensaje(msg) {

  const el = document.getElementById("overlay-msg");
  el.textContent = msg;

  // reset visual (por si algo qued√≥ sucio antes)
  el.style.color = "";
  el.style.fontWeight = "";
}

document.getElementById("volver-idioma").addEventListener("click", () => {

  document.getElementById("pantalla-idioma").style.display = "flex";
  document.getElementById("main-encuesta").style.display = "none";

  // üî• Limpia TODOS los errores y estilos
  document.querySelectorAll(".error-msg").forEach(e => e.style.display = "none");
  document.querySelectorAll(".input-error").forEach(e => e.classList.remove("input-error"));
  document.querySelectorAll(".group-error").forEach(e => e.classList.remove("group-error"));
  document.querySelectorAll(".selected").forEach(e => e.classList.remove("selected"));

});

// === GUARDAR SELECCIONES DE RADIO ===
function guardarSeleccionRadios() {
    const radios = document.querySelectorAll('input[type="radio"]');
    radios.forEach(radio => {
        radio.addEventListener('change', () => {
            localStorage.setItem(radio.name, radio.value);
        });
    });
}

// === RESTAURAR SELECCIONES DE RADIO ===
function restaurarSeleccionRadios() {
    const radios = document.querySelectorAll('input[type="radio"]');
    radios.forEach(radio => {
        const valorGuardado = localStorage.getItem(radio.name);
        if (valorGuardado && radio.value === valorGuardado) {
            radio.checked = true;
        }
    });
}

/* ============================================================
   FUNCI√ìN PARA CAMBIAR IDIOMA ‚Äî REQUERIDA PARA QUE NO EXPLOTE
============================================================ */
function cambiarIdioma(lang) {
  const t = traducciones[lang];
  if (!t) return;

  const setText = (id, text) => {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
  };

  // T√çTULOS
  setText("titulo-encuesta", t.header);
  setText("title-window", t.titulo);

  // LABELS
  setText("label-nombre",
    lang === "es" ? "Nombre:" :
    lang === "en" ? "Name:" : "Nom:"
  );

  setText("label-telefono",
    lang === "es" ? "N√∫mero telef√≥nico:" :
    lang === "en" ? "Phone number:" : "Num√©ro de t√©l√©phone:"
  );

  setText("label-correoelectr√≥nico",
    lang === "es" ? "Correo electr√≥nico:" :
    lang === "en" ? "Email:" : "E-mail:"
  );

  setText("label-lugar",
    lang === "es" ? "Lugar:" :
    lang === "en" ? "Place:" : "Lieu:"
  );

  setText("label-fecha",
    lang === "es" ? "Fecha:" :
    lang === "en" ? "Date:" : "Date:"
  );

  setText("label-tour", "Tour:");
  setText("label-conductor",
    lang === "es" ? "Conductor:" :
    lang === "en" ? "Driver:" : "Conducteur:"
  );

  setText("label-transporte",
    lang === "es" ? "Transporte:" :
    lang === "en" ? "Transport:" : "Transport:"
  );

  setText("label-alimentos",
    lang === "es" ? "Alimentos:" :
    lang === "en" ? "Food:" : "Nourriture:"
  );

  setText("label-comentarios",
    lang === "es" ? "Comentarios (opcional):" :
    lang === "en" ? "Comments (optional):" :
                    "Commentaires (facultatif):"
  );

  setText("guardarEncuesta",
    lang === "es" ? "Terminar Encuesta" :
    lang === "en" ? "Finish Survey" :
                    "Terminer l'enqu√™te"
  );
}

const mensajesEnvio = {
  es: {
    enviando: "Terminando la Encuesta, por favor no cierre ni refresque esta p√°gina‚Ä¶",
    ok: "Encuesta enviada correctamente",
    error: "Error al enviar la encuesta"
  },
  en: {
    enviando: "Finishing the survey, please do not close or refresh this page‚Ä¶",
    ok: "Survey sent successfully",
    error: "Error sending the survey"
  },
  fr: {
    enviando: "Apr√®s avoir r√©pondu au sondage, veuillez ne pas fermer ni actualiser cette page‚Ä¶",
    ok: "Sondage envoy√© avec succ√®s",
    error: "Erreur lors de l‚Äôenvoi du sondage"
  }
};

const opciones = {
  es: ["Excelente", "Bueno", "Regular", "Malo"],
  en: ["Excellent", "Good", "Average", "Bad"],
  fr: ["Excellent", "Bon", "Moyen", "Mauvais"]
};

document.querySelectorAll(".btn-group").forEach(group => {
  group.querySelectorAll("button").forEach((btn, i) => {
    btn.textContent = opciones[idiomaActual][i];
  });
});

/* ============================================================
   LIMPIAR CAMPOS AL CAMBIAR IDIOMA
============================================================ */
function limpiarCamposTexto() {
  const campos = document.querySelectorAll("input[type='text'], textarea");

  campos.forEach(c => {
    // SI es el campo de fecha, NO lo borres
    if (c.id === "fecha") return;

    // Limpia los dem√°s
    c.value = "";
  });

  // Limpia tambi√©n los radios y checkboxes seleccionados
  const seleccionables = document.querySelectorAll("input[type='radio'], input[type='checkbox']");
  seleccionables.forEach(s => s.checked = false);
}

// --- GUARDAR SELECCIONES ---
function saveFormState() {
    const elements = document.querySelectorAll("input, select, textarea");

    elements.forEach(el => {
        if (el.type === "radio" || el.type === "checkbox") {
            localStorage.setItem(el.id, el.checked);
        } else {
            localStorage.setItem(el.id, el.value);
        }
    });
}

// --- CARGAR SELECCIONES ---
function loadFormState() {
    const elements = document.querySelectorAll("input, select, textarea");

    elements.forEach(el => {
        const stored = localStorage.getItem(el.id);

        if (stored === null) return;

        if (el.type === "radio" || el.type === "checkbox") {
            el.checked = stored === "true";
        } else {
            el.value = stored;
        }
    });
}

// --- GUARDAR AUTOM√ÅTICAMENTE CADA VEZ QUE TOCAN ALGO ---
document.addEventListener("change", saveFormState);

// --- CARGAR AL ABRIR LA P√ÅGINA ---
setTimeout(fijarPrefijoActual, 0);

function resetearFormularioCompleto() {

  // Limpia textos de inputs y textareas
  document.querySelectorAll("input, textarea").forEach(el => {
    el.value = "";
    el.style.height = "auto"; // reset del autoexpand
  });

  // Limpia selecci√≥n de botones tipo encuesta
  document.querySelectorAll(".btn-group button").forEach(btn => {
    btn.classList.remove("selected");
  });

  // Oculta todos los mensajes de error
  document.querySelectorAll(".error-msg").forEach(err => {
    err.style.display = "none";
  });

  // Quita estilos de error
  document.querySelectorAll(".input-error").forEach(el => {
    el.classList.remove("input-error");
  });
  document.querySelectorAll(".group-error").forEach(el => {
    el.classList.remove("group-error");
  });

  // Limpia TODO el almacenamiento
  localStorage.clear();
}


// === BOT√ìN: VOLVER A IDIOMA ===
document.getElementById("volver-idioma").addEventListener("click", () => {

  paisInicialPorIdioma(idiomaActual);
fijarPrefijoActual();

  // Mostrar selecci√≥n de idioma
  document.getElementById("pantalla-idioma").style.display = "flex";
  document.getElementById("main-encuesta").style.display = "none";

  // üî• Limpia todo al 100%
  resetearFormularioCompleto();
});

// üëá Inicializa Flatpickr apenas cargue la p√°gina
document.addEventListener("DOMContentLoaded", () => {
    window.fpFecha = flatpickr("#fecha", {
        dateFormat: "d/m/Y",
        locale: flatpickr.l10ns.es
    });
});

document.getElementById("idioma")?.addEventListener("change", function () {
    const lang = this.value;
    localStorage.setItem("lang", lang);

    // Reinit del calendario
    flatpickr("#fecha", {
        locale: lang === "es" ? "es" : "en",
        dateFormat: "Y-m-d",
        defaultDate: new Date()
    });
});

  document.addEventListener("DOMContentLoaded", () => {
  });

/* ---------- inicializaci√≥n √∫nica y fija de flatpickr ---------- */
(function() {
  // Aseg√∫rate de ejecutar esto cuando el DOM est√© listo
  document.addEventListener("DOMContentLoaded", () => {

    // Funci√≥n que (re)inicia flatpickr en #fecha con la localizaci√≥n pasada
    function crearFlatpickr(local) {
      // Si ya existe, destr√∫yelo para evitar duplicados
      if (window.fpFecha && typeof window.fpFecha.destroy === "function") {
        try { window.fpFecha.destroy(); } catch(e){ /* no importa */ }
      }

      // Inicializa y guarda la instancia globalmente
      window.fpFecha = flatpickr("#fecha", {
        dateFormat: "d/m/Y",      // formato interno
        altInput: true,           // campo alterno para mostrar bonito
        altFormat: "d/m/Y",       // formato visible
        defaultDate: new Date(),  // pone hoy como valor inicial (as√≠ aparece el a√±o)
        allowInput: true,
        locale: local || "es",    // 'es','en' o 'fr'
        onReady: function(selectedDates, dateStr, instance) {
          // Si el campo aparece vac√≠o por CSS u overlay, forzamos que muestre el altInput value
          try {
            instance.input.value = instance.altInput ? instance.altInput.value : dateStr;
          } catch(e){ /* noop */ }
          console.log("flatpickr listo:", local);
        },
        onOpen: function() {
          // √∫til para pruebas: abre y asegura que el encabezado del calendario tenga texto
          setTimeout(()=> {
            const yearEl = document.querySelector(".flatpickr-current-month .numInputWrapper input.cur-year");
            if (yearEl && yearEl.value === "") {
              // forzamos el a√±o a mostrar si por alg√∫n motivo est√° vac√≠o
              yearEl.value = (new Date()).getFullYear();
            }
          }, 50);
        }
      });
    }

    // Al inicio, crea con espa√±ol por defecto
    crearFlatpickr("es");

    // Cuando el usuario elige idioma (ya tienes botones con data-lang)
    document.querySelectorAll("#pantalla-idioma button").forEach(b => {
      b.addEventListener("click", () => {
        const lang = b.dataset.lang || "es";

        // traducir textos ya lo manejas con cambiarIdioma(), solo reiniciamos flatpickr
        // flatpickr admite strings 'es'/'en'/'fr' si las localizaciones fueron cargadas
        crearFlatpickr(lang);
      });
    });

  }); // DOMContentLoaded
})(); 

const fechaInput = document.getElementById("fecha");

const fp = flatpickr(fechaInput, {
  dateFormat: "Y-m-d",
  defaultDate: new Date(),
  locale: "es"  // idioma inicial
});

function limpiarCamposTexto() {
    const inputs = document.querySelectorAll("input, textarea, select");

    inputs.forEach(el => {
        // NO borrar la fecha
        if (el.id === "fecha" || el.name === "fecha") return;

        // Radio y checkbox se desmarcan
        if (el.type === "radio" || el.type === "checkbox") {
            el.checked = false;
        }
        // Todo lo dem√°s se vac√≠a
        else {
            el.value = "";
        }
    });
}

</script>

<script>
  
document.addEventListener("DOMContentLoaded", () => {

    // ---- LISTENERS SEGUROS ----
    document.getElementById("volver-idioma")?.addEventListener("click", () => {
        // c√≥digo aqu√≠
    });

    document.getElementById("btn-es")?.addEventListener("click", () => {
        cambiarIdioma("es");
    });

    document.getElementById("btn-en")?.addEventListener("click", () => {
        cambiarIdioma("en");
    });

    document.getElementById("btn-fr")?.addEventListener("click", () => {
        cambiarIdioma("fr");
    });

    // ---- FLATPICKR ----
    const fp = flatpickr("#fecha", {
        dateFormat: "Y-m-d",
        locale: "es"
    });
});

</script>

<!-- CONFIRMADOR PERSONALIZADO -->
<div id="confirmador" class="confirm-overlay" style="display:none;">
  <div class="confirm-box">
    <h3>¬øDesea continuar?</h3>
    <div class="confirm-btns">
      <button id="btnConfirmar" class="btn-verde">Continuar</button>
      <button id="btnCancelar" class="btn-rojo">Cancelar</button>
    </div>
  </div>
</div>

</body>
</html>